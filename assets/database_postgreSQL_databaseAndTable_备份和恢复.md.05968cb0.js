import{_ as e,o as s,c as o,R as t}from"./chunks/framework.333b51ca.js";const m=JSON.parse('{"title":"在 PostgreSQL 备份和恢复数据库指南","description":"","frontmatter":{},"headers":[],"relativePath":"database/postgreSQL/databaseAndTable/备份和恢复.md","filePath":"database/postgreSQL/databaseAndTable/备份和恢复.md","lastUpdated":1689061386000}'),a={name:"database/postgreSQL/databaseAndTable/备份和恢复.md"},d=t('<h1 id="在-postgresql-备份和恢复数据库指南" tabindex="-1">在 PostgreSQL 备份和恢复数据库指南 <a class="header-anchor" href="#在-postgresql-备份和恢复数据库指南" aria-label="Permalink to &quot;在 PostgreSQL 备份和恢复数据库指南&quot;">​</a></h1><p>本文介绍如何使用 <code>pg_dump</code> 和 <code>pg_dumpall</code> 备份 PostgreSQL 数据库以及如何使用 <code>pg_restore</code> 恢复 PostgreSQL 数据库。</p><p>PostgreSQL 提供了 <code>pg_dump</code> 和 <code>pg_dumpall</code> 工具，帮助您轻松地备份数据库，同时，PostgreSQL 提供了 <code>pg_restore</code> 工具，帮助您轻松的恢复数据库。</p><p>作为数据库管理员，备份和恢复是必备的技能。 PostgreSQL 为我们提供了很多方便的工具或命令来做到这些。</p><p>备份数据库的工具或命令：</p><ul><li><code>pg_dump</code> 工具用于备份单个 PostgreSQL 数据库</li><li><code>pg_dumpall</code> 工具用于备份 PostgreSQL 服务器中的所有的数据库。</li></ul><p>恢复数据库的工具或命令：</p><ul><li><code>pg_restore</code> 工具用于恢复由 <code>pg_dump</code> 工具产生的 tar 文档和目录文档。</li><li><code>psql</code> 工具可以导入 <code>pg_dump</code> 和 <code>pg_dumpall</code> 工具产生的 SQL 脚本文件。</li><li><code>\\i</code> 命令可以导入 <code>pg_dump</code> 和 <code>pg_dumpall</code> 工具产生的 SQL 脚本文件。</li></ul><h2 id="使用-pg-dump-备份一个数据库" tabindex="-1">使用 <code>pg_dump</code> 备份一个数据库 <a class="header-anchor" href="#使用-pg-dump-备份一个数据库" aria-label="Permalink to &quot;使用 `pg_dump` 备份一个数据库&quot;">​</a></h2><p>PostgreSQL 自带了 <code>pg_dump</code> 工具用于备份单个 PostgreSQL 数据库。 以下是一个常用的备份命令：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">pg_dump </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">U username </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">W </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">F t db_name </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> output.tar</span></span></code></pre></div><p>说明：</p><ul><li><code>-U username</code>: 指定连接 PostgreSQL 数据库服务器的用户。您可以在 <code>username</code> 位置使用自己的用户名。</li><li><code>-W</code>: 强制 <code>pg_dump</code> 在连接到 PostgreSQL 数据库服务器之前提示输入密码。按回车后， <code>pg_dump</code> 会提示输入 <code>postgres</code> 用户密码。</li><li><code>-F</code> : 指定输出文件的格式，它可以是以下格式之一： <ul><li><code>c</code>: 自定义格式</li><li><code>d</code>: 目录格式存档</li><li><code>t</code>: tar 文件包</li><li><code>p</code>: SQL 脚本文件</li></ul></li><li><code>db_name</code> 是要备份的数据库的名字。</li><li><code>output.tar</code> 是输出文件的路径。</li></ul><p>如果您在命令行或者终端工具中运行命令是提示找不到 <code>pg_dump</code> 工具，请先导航到 PostgreSQL bin 文件夹。例如：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">C:\\</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">cd C:\\Program Files\\PostgreSQL\\</span><span style="color:#F78C6C;">14</span><span style="color:#A6ACCD;">\\bin</span></span></code></pre></div><h2 id="使用-pg-dumpall-备份所有数据库" tabindex="-1">使用 <code>pg_dumpall</code> 备份所有数据库 <a class="header-anchor" href="#使用-pg-dumpall-备份所有数据库" aria-label="Permalink to &quot;使用 `pg_dumpall` 备份所有数据库&quot;">​</a></h2><p>除了 <code>pg_dump</code> 工具，PostgreSQL 还提供了可以一次备份所有数据库的 <code>pg_dumpall</code> 工具备份。 该 <code>pg_dumpall</code> 工具的用法如下：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">pg_dumpall </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">U username </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> output.sql</span></span></code></pre></div><h2 id="使用-pg-restore-恢复数据库" tabindex="-1">使用 <code>pg_restore</code> 恢复数据库 <a class="header-anchor" href="#使用-pg-restore-恢复数据库" aria-label="Permalink to &quot;使用 `pg_restore` 恢复数据库&quot;">​</a></h2><p>PostgreSQL 提供了 <code>pg_restore</code> 工具用于恢复由 <code>pg_dump</code> 工具产生的 tar 文档和目录文档。</p><p><code>pg_restore</code> 工具的用法如下：</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">pg_restore</span><span style="color:#A6ACCD;"> [option...] file_path</span></span></code></pre></div><p>说明：</p><ul><li><p><code>file_path</code> 是要恢复的文件或者目录的路径。</p></li><li><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">option</span></span></code></pre></div><p>是一些恢复数据时用到的参数，比如，数据库，主机，端口 等。 您可以使用如下选项：</p><table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td><code>-a</code> <code>--data-only</code></td><td>只恢复数据，而不恢复表模式（数据定义）。</td></tr><tr><td><code>-c</code> <code>--clean</code></td><td>创建数据库对象前先清理（删除）它们。</td></tr><tr><td><code>-C</code> <code>--create</code></td><td>在恢复数据库之前先创建它。</td></tr><tr><td><code>-d dbname</code> <code>--dbname=dbname</code></td><td>与数据库 dbname 联接并且直接恢复到该数据库中。</td></tr><tr><td><code>-e</code> <code>--exit-on-error</code></td><td>如果在向数据库发送 SQL 命令的时候碰到错误，则退出。缺省是继续执行并且在恢复 结束时显示一个错误计数。</td></tr><tr><td><code>-f filename</code> <code>--file=filename</code></td><td>声明生成的脚本的输出文件，或者出现-l 选项时用于列表的文件，缺省是标准输出。</td></tr><tr><td><code>-F format</code> <code>--format=format</code></td><td>声明备份文件的格式。</td></tr><tr><td><code>-i</code> <code>--ignore-version</code></td><td>忽略数据库版本检查。</td></tr><tr><td><code>-I index</code> <code>--index=index</code></td><td>只恢复命名的索引。</td></tr><tr><td><code>-l</code> <code>--list</code></td><td>列出备份的内容。这个操作的输出可以用 -L 选项限制和重排所恢复的项目。</td></tr><tr><td><code>-L list-file</code> <code>--use-list=list-file</code></td><td>只恢复在 list-file 里面的元素，以它们在文件中出现的顺序。</td></tr><tr><td><code>-n namespace</code> <code>--schema=schema</code></td><td>只恢复指定名字的模式里面的定义和/或数据。不要和 -s 选项混淆。这个选项可以和 -t 选项一起使用。</td></tr><tr><td><code>-O</code> <code>--no-owner</code></td><td>不要输出设置对象的权限，以便与最初的数据库匹配的命令。</td></tr><tr><td><code>-s</code> <code>--schema-only</code></td><td>只恢复表结构（数据定义）。不恢复数据，序列值将重置。</td></tr><tr><td><code>-S username</code> <code>--superuser=username</code></td><td>设置关闭触发器时声明超级用户的用户名。只有在设置了 –disable-triggers 的时候 才有用。</td></tr><tr><td><code>-t table</code> <code>--table=table</code></td><td>只恢复表指定的表的定义和/或数据。</td></tr><tr><td><code>-T trigger</code> <code>--trigger=trigger</code></td><td>只恢复指定的触发器。</td></tr><tr><td><code>-v</code> <code>--verbose</code></td><td>声明冗余模式。</td></tr><tr><td><code>-x</code> <code>--no-privileges</code> <code>--no-acl</code></td><td>避免 ACL 的恢复（grant/revoke 命令）</td></tr><tr><td><code>-X use-set-session-authorization</code> <code>--use-set-session-authorization</code></td><td>输出 SQL 标准的 SET SESSION AUTHORIZATION 命令，而不是 OWNER TO 命令。</td></tr><tr><td><code>-X disable-triggers</code> <code>--disable-triggers</code></td><td>这个选项只有在执行仅恢复数据的时候才相关。</td></tr><tr><td><code>-h host</code> <code>--host=host</code></td><td>声明服务器运行的机器的主机名。</td></tr><tr><td><code>-p port</code> <code>--port=port</code></td><td>声明服务器侦听的 TCP 端口或者本地的 Unix 域套接字文件扩展。</td></tr><tr><td><code>-U username</code></td><td>以给出用户身分联接。</td></tr><tr><td><code>-W</code></td><td>强制给出口令提示。如果服务器要求口令认证，那么这个应该自动发生。</td></tr></tbody></table></li></ul><p>最常用的 <code>pg_restore</code> 用法如下：</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">pg_restore</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-d</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">db_name</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">path_to_db_backup_file.tar</span></span></code></pre></div><h2 id="如何使用-psql-恢复数据库" tabindex="-1">如何使用 psql 恢复数据库 <a class="header-anchor" href="#如何使用-psql-恢复数据库" aria-label="Permalink to &quot;如何使用 psql 恢复数据库&quot;">​</a></h2><p>您可以使用 psql 工具从一个 sql 文件中恢复数据。 以下是使用 psql 从 sql 文件恢复数据的基本用法：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">psql </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">U username </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">f path_to_db_backup_file.sql</span></span></code></pre></div><h2 id="使用-i-命令导入-sql-文件" tabindex="-1">使用 <code>\\i</code> 命令导入 sql 文件 <a class="header-anchor" href="#使用-i-命令导入-sql-文件" aria-label="Permalink to &quot;使用 `\\i` 命令导入 sql 文件&quot;">​</a></h2><p>您还可以 <code>\\i</code> 命令导入 sql 文件。 以下演示了<a href="/database/sakila/">导入 sakila 示例数据库</a> 的步骤：</p><ol><li><p>启动 psql 工具并连接 PostgreSQL 服务器：</p><div class="language-powershell"><button title="Copy Code" class="copy"></button><span class="lang">powershell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">.\\</span><span style="color:#82AAFF;">psql.exe</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">U postgres</span></span></code></pre></div><p>根据提示输入 postgres 用户的密码，然后按下回车键。</p></li><li><p>创建 sakila 数据库</p><div class="language-postgresql"><button title="Copy Code" class="copy"></button><span class="lang">postgresql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">CREATE DATABASE sakila;</span></span></code></pre></div></li><li><p>连接 sakila 数据库</p><div class="language-postgresql"><button title="Copy Code" class="copy"></button><span class="lang">postgresql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">\\c sakila;</span></span></code></pre></div></li><li><p>分别使用以下两个语句以导入刚刚下载的两个文件 <code>postgres-sakila-schema.sql</code> 和 <code>postgres-sakila-insert-data.sql</code> ：</p><div class="language-postgresql"><button title="Copy Code" class="copy"></button><span class="lang">postgresql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">\\i C:/Users/Adam/Downloads/postgres-sakila-schema.sql</span></span>\n<span class="line"><span style="color:#A6ACCD;">\\i C:/Users/Adam/Downloads/postgres-sakila-insert-data.sql</span></span></code></pre></div><p>请注意，请使用 <code>/</code> 替换文件路径中的 <code>\\</code> 。</p></li></ol><h2 id="结论" tabindex="-1">结论 <a class="header-anchor" href="#结论" aria-label="Permalink to &quot;结论&quot;">​</a></h2><p>本文讨论了备份和恢复 PostgreSQL 数据库的几种方法。</p>',34),l=[d];function c(p,r,n,i,g,u){return s(),o("div",null,l)}const C=e(a,[["render",c]]);export{m as __pageData,C as default};
