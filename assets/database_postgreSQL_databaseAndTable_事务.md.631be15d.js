import{_ as s,o as a,c as l,R as n}from"./chunks/framework.333b51ca.js";const F=JSON.parse('{"title":"PostgreSQL 事务 - 保证交易的完整性","description":"","frontmatter":{},"headers":[],"relativePath":"database/postgreSQL/databaseAndTable/事务.md","filePath":"database/postgreSQL/databaseAndTable/事务.md","lastUpdated":1690289709000}'),p={name:"database/postgreSQL/databaseAndTable/事务.md"},o=n(`<h1 id="postgresql-事务-保证交易的完整性" tabindex="-1">PostgreSQL 事务 - 保证交易的完整性 <a class="header-anchor" href="#postgresql-事务-保证交易的完整性" aria-label="Permalink to &quot;PostgreSQL 事务 - 保证交易的完整性&quot;">​</a></h1><p>本文介绍了在 PostgreSQL 中如何开启、提交和回滚事务。</p><p>数据库事务是一种保证交易的完整性的机制。事务是一个不可分隔的工作单元，一个事务之内的所有的操作要么全部执行，要么全部不执行。</p><p>比如，在一个银行系统中，用户 A 向用户 B 转账 500 元。这个交易主要包含两个操作：</p><ol><li>从用户 A 的账户余额扣除 500 元。</li><li>将用户 B 的账户余额增加 500 元。</li></ol><p>上面的两个操作要么全部执行，要么全部不执行，否则会带来错误。</p><h2 id="数据库事务的特性" tabindex="-1">数据库事务的特性 <a class="header-anchor" href="#数据库事务的特性" aria-label="Permalink to &quot;数据库事务的特性&quot;">​</a></h2><p>数据库事务具有四大特性：</p><ul><li>原子性(Atomicity)： 事务中的操作要么全部执行，要么全部不执行。</li><li>一致性(Consistency)： 一个事务必须是数据库从一个一致状态变成另一个一致状态。</li><li>隔离性(Isolation)： 多个事务并发执行时，一个事务的执行不应影响其他事务的执行。</li><li>持久性(Durability)： 已提交的事务将永久存储在数据库中。</li></ul><p>数据库事务的四大特性通常被简称为 ACID。</p><h2 id="postgresql-事务命令" tabindex="-1">PostgreSQL 事务命令 <a class="header-anchor" href="#postgresql-事务命令" aria-label="Permalink to &quot;PostgreSQL 事务命令&quot;">​</a></h2><p>PostgreSQL 提供了一些 SQL 命令用来控制事务，包括：开启一个事务、提交一个事务、回滚一个事务。</p><h3 id="开启一个事务" tabindex="-1">开启一个事务 <a class="header-anchor" href="#开启一个事务" aria-label="Permalink to &quot;开启一个事务&quot;">​</a></h3><p>要开启一个 PostgreSQL 数据库事务，您可以使用以下命令中的一个：</p><ul><li><code>START TRANSACTION;</code></li><li><code>BEGIN TRANSACTION;</code></li><li><code>BEGIN WORK;</code></li><li><code>BEGIN;</code></li></ul><p>开启一个事务后，后续的所有操作都属于该事务，直到事务被提交或者被回滚。</p><h3 id="提交一个事务" tabindex="-1">提交一个事务 <a class="header-anchor" href="#提交一个事务" aria-label="Permalink to &quot;提交一个事务&quot;">​</a></h3><p>要提交该事务内的所有操作，您可以使用以下命令中的一个：</p><ul><li><code>COMMIT TRANSACTION;</code></li><li><code>COMMIT WORK;</code></li><li><code>COMMIT;</code></li></ul><p>提交事务将当前事务内的所有操作写入数据库，并结束当前事务。</p><h3 id="回滚一个事务" tabindex="-1">回滚一个事务 <a class="header-anchor" href="#回滚一个事务" aria-label="Permalink to &quot;回滚一个事务&quot;">​</a></h3><p>要回滚该事务内的所有操作，您可以使用以下命令中的一个：</p><ul><li><code>ROLLBACK TRANSACTION;</code></li><li><code>ROLLBACK WORK;</code></li><li><code>ROLLBACK;</code></li></ul><p>回滚事务将撤销当前事务内的所有的操作，并结束当前事务。</p><h2 id="postgresql-事务实例" tabindex="-1">PostgreSQL 事务实例 <a class="header-anchor" href="#postgresql-事务实例" aria-label="Permalink to &quot;PostgreSQL 事务实例&quot;">​</a></h2><p>我们将通过一个银行账户余额的表来演示事务。下面的语句<a href="./创建表.html">创建了表</a> <code>user_balance</code>:</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">CREATE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">TABLE</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">user_balance</span><span style="color:#A6ACCD;"> (</span></span>
<span class="line"><span style="color:#A6ACCD;">  id </span><span style="color:#C792EA;">INTEGER</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">PRIMARY KEY</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">name</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">VARCHAR</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">100</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">NOT NULL</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  balance </span><span style="color:#F78C6C;">DEC</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">15</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">NOT NULL</span></span>
<span class="line"><span style="color:#A6ACCD;">);</span></span></code></pre></div><h3 id="事务初体验" tabindex="-1">事务初体验 <a class="header-anchor" href="#事务初体验" aria-label="Permalink to &quot;事务初体验&quot;">​</a></h3><p>让我们在一个事务中插入一个数据，以演示事务的用法。</p><ol><li><p>（会话 1）使用下面的语句开启一个事务：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">BEGIN</span><span style="color:#A6ACCD;">;</span></span></code></pre></div></li><li><p>（会话 1）使用下面的语句插入一行数据：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">INSERT INTO</span><span style="color:#A6ACCD;"> user_balance (id, </span><span style="color:#F78C6C;">name</span><span style="color:#A6ACCD;">, balance)</span></span>
<span class="line"><span style="color:#F78C6C;">VALUES</span><span style="color:#A6ACCD;"> (</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Tom</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">2500</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">);</span></span></code></pre></div></li><li><p>（会话 1）使用下面的语句查看 <code>user_balance</code> 表中数据：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> user_balance;</span></span></code></pre></div><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">id</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">name</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">balance</span></span>
<span class="line"><span style="color:#FFCB6B;">----+------+---------</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">1</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Tom</span><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">2500.00</span></span>
<span class="line"><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">1</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">row</span><span style="color:#89DDFF;">)</span></span></code></pre></div></li><li><p>（会话 2）重新打开一个会话并登录到刚刚的数据库中，使用下面的语句查看 <code>user_balance</code> 表中数据：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> user_balance;</span></span></code></pre></div><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">id</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">name</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">balance</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">----+------+---------</span></span>
<span class="line"><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">0</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">rows</span><span style="color:#89DDFF;">)</span></span></code></pre></div><p>这里，您并不能看到刚刚插入的行。这是因为在会话 1 中的插入操作在一个事务中，并且事务还未提交，因此事务之外并不能看到还未提交的数据。</p></li><li><p>（会话 1）回到原来的会话，使用下面的语句提交事务：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">COMMIT</span><span style="color:#A6ACCD;">;</span></span></code></pre></div></li><li><p>（会话 2）回到会话 2，使用下面的语句查看 <code>user_balance</code> 表中数据：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> user_balance;</span></span></code></pre></div><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">id | </span><span style="color:#F78C6C;">name</span><span style="color:#A6ACCD;"> | balance</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">----+------+---------</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> | Tom  | </span><span style="color:#F78C6C;">2500</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span></span>
<span class="line"><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">row</span><span style="color:#A6ACCD;">)</span></span></code></pre></div><p>此时，由于会话 1 中的事务已经提交，您可以在会话 2 中看到刚刚插入的行了。</p></li></ol><h3 id="银行转账-事务中的多个操作" tabindex="-1">银行转账：事务中的多个操作 <a class="header-anchor" href="#银行转账-事务中的多个操作" aria-label="Permalink to &quot;银行转账：事务中的多个操作&quot;">​</a></h3><p>使用下面的语句插入 2 行数据用于这个示例：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">INSERT INTO</span><span style="color:#A6ACCD;"> user_balance (id, </span><span style="color:#F78C6C;">name</span><span style="color:#A6ACCD;">, balance)</span></span>
<span class="line"><span style="color:#F78C6C;">VALUES</span><span style="color:#A6ACCD;"> (</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Tim</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">1500</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">), (</span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Jim</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">1000</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">);</span></span></code></pre></div><p>使用下面的语句看一下 <code>user_balance</code> 表中行：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> user_balance;</span></span></code></pre></div><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">id | </span><span style="color:#F78C6C;">name</span><span style="color:#A6ACCD;"> | balance</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">----+------+---------</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> | Tom  | </span><span style="color:#F78C6C;">2500</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;"> | Tim  | </span><span style="color:#F78C6C;">1500</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;"> | Jim  | </span><span style="color:#F78C6C;">1000</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span></span>
<span class="line"><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">rows</span><span style="color:#A6ACCD;">)</span></span></code></pre></div><p>假设， Tom 需要向 Tim 转账 500 元。您需要完成如下两个操作：</p><ol><li>将 Tom 的余额扣减 500 元</li><li>将 Tim 的余额增加 500 元</li></ol><p>这里有两个操作，为了保证转账交易的完整性，因此我们需要使用事务。</p><ol><li><p>使用下面的语句开启一个事务：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">BEGIN</span><span style="color:#A6ACCD;">;</span></span></code></pre></div></li><li><p>使用下面的语句将 Tom 的余额减少 500 元：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">UPDATE</span><span style="color:#A6ACCD;"> user_balance</span></span>
<span class="line"><span style="color:#F78C6C;">SET</span><span style="color:#A6ACCD;"> balance </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> balance </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">500</span></span>
<span class="line"><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">;</span></span></code></pre></div></li><li><p>使用下面的语句将 Tim 的余额增加 500 元：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">UPDATE</span><span style="color:#A6ACCD;"> user_balance</span></span>
<span class="line"><span style="color:#F78C6C;">SET</span><span style="color:#A6ACCD;"> balance </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> balance </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">500</span></span>
<span class="line"><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">;</span></span></code></pre></div></li><li><p>使用下面的语句查看 <code>user_balance</code> 表中数据，已验证数据的是否正确：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span></span>
<span class="line"><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> user_balance</span></span>
<span class="line"><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> id </span><span style="color:#F78C6C;">IN</span><span style="color:#A6ACCD;"> (</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">, </span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">);</span></span></code></pre></div><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">id | </span><span style="color:#F78C6C;">name</span><span style="color:#A6ACCD;"> | balance</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">----+------+---------</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> | Tom  | </span><span style="color:#F78C6C;">2000</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;"> | Tim  | </span><span style="color:#F78C6C;">2000</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span></span>
<span class="line"><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">rows</span><span style="color:#A6ACCD;">)</span></span></code></pre></div><p>这里，Tom 和 Tim 转账后的余额都是正确的。</p></li><li><p>使用下面的语句提交事务：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">COMMIT</span><span style="color:#A6ACCD;">;</span></span></code></pre></div></li></ol><h3 id="回滚事务" tabindex="-1">回滚事务 <a class="header-anchor" href="#回滚事务" aria-label="Permalink to &quot;回滚事务&quot;">​</a></h3><p>如果在提交事务之前出现了任何异常，您都可以通过回滚事务来撤销之前的操作。</p><p>比如，您不小心将钱转账给了 id 为 3 的用户，只要您在提交之前发现了问题， 您可以通过 <code>ROLLBACK</code> 命令回滚当前事务。</p><p>首先，看一下当前 <code>user_balance</code> 表中的行：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> user_balance;</span></span></code></pre></div><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">id</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">name</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">balance</span></span>
<span class="line"><span style="color:#FFCB6B;">----+------+---------</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">3</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Jim</span><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">1000.00</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">1</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Tom</span><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">2000.00</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">2</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Tim</span><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">2000.00</span></span>
<span class="line"><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">3</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">rows</span><span style="color:#89DDFF;">)</span></span></code></pre></div><p>下面的语句假设您不小心将钱转账给了 id 为 3 的用户：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">BEGIN</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">UPDATE</span><span style="color:#A6ACCD;"> user_balance</span></span>
<span class="line"><span style="color:#F78C6C;">SET</span><span style="color:#A6ACCD;"> balance </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> balance </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">500</span></span>
<span class="line"><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">UPDATE</span><span style="color:#A6ACCD;"> user_balance</span></span>
<span class="line"><span style="color:#F78C6C;">SET</span><span style="color:#A6ACCD;"> balance </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> balance </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">500</span></span>
<span class="line"><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;">;</span></span></code></pre></div><p>在提交之前您使用以下语句检查操作是否正确：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span></span>
<span class="line"><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> user_balance</span></span>
<span class="line"><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> id </span><span style="color:#F78C6C;">IN</span><span style="color:#A6ACCD;"> (</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">, </span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">);</span></span></code></pre></div><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">id | </span><span style="color:#F78C6C;">name</span><span style="color:#A6ACCD;"> | balance</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">----+------+---------</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;"> | Tim  | </span><span style="color:#F78C6C;">2000</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> | Tom  | </span><span style="color:#F78C6C;">1500</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span></span>
<span class="line"><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">rows</span><span style="color:#A6ACCD;">)</span></span></code></pre></div><p>您发现 Tom 的余额少了 500， 而 Tim 的余额没有变化。这是一个错误。因此您需要使用 <code>ROLLBACK</code> 来回滚事务。</p><p>事务被回滚后，数据恢复到操作之前的状态，您就可以继续完成转账了。</p><h2 id="结论" tabindex="-1">结论 <a class="header-anchor" href="#结论" aria-label="Permalink to &quot;结论&quot;">​</a></h2><p>在 PostgreSQL 中，事务可以保证交易的完整性。 <code>BEGIN</code> 语句用于开启一个事务，<code>COMMIT</code> 语句用户提交一个事务 和 <code>ROLLBACK</code> 语句用户回滚一个事务。</p>`,55),e=[o];function c(t,C,r,y,i,A){return a(),l("div",null,e)}const d=s(p,[["render",c]]);export{F as __pageData,d as default};
