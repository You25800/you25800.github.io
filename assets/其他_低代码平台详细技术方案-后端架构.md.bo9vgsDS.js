import{_ as i,c as a,o as n,b3 as h}from"./chunks/framework.CatkIGlB.js";const A=JSON.parse('{"title":"低代码平台详细技术方案 - 后端架构","description":"","frontmatter":{},"headers":[],"relativePath":"其他/低代码平台详细技术方案-后端架构.md","filePath":"其他/低代码平台详细技术方案-后端架构.md","lastUpdated":null}'),k={name:"其他/低代码平台详细技术方案-后端架构.md"};function l(t,s,p,e,D,r){return n(),a("div",null,[...s[0]||(s[0]=[h(`<h1 id="低代码平台详细技术方案-后端架构" tabindex="-1">低代码平台详细技术方案 - 后端架构 <a class="header-anchor" href="#低代码平台详细技术方案-后端架构" aria-label="Permalink to &quot;低代码平台详细技术方案 - 后端架构&quot;">​</a></h1><blockquote><p>基于 Golang (Gin + GORM + go-redis) + PostgreSQL + Elasticsearch</p></blockquote><hr><h2 id="目录" tabindex="-1">目录 <a class="header-anchor" href="#目录" aria-label="Permalink to &quot;目录&quot;">​</a></h2><ul><li><a href="#一项目整体结构">一、项目整体结构</a></li><li><a href="#二gin-中间件体系">二、Gin 中间件体系</a></li><li><a href="#三gorm-模型设计">三、GORM 模型设计</a></li><li><a href="#四redis-缓存策略">四、Redis 缓存策略</a></li><li><a href="#五api-接口规范">五、API 接口规范</a></li><li><a href="#六核心服务实现">六、核心服务实现</a></li><li><a href="#七配置文件">七、配置文件</a></li></ul><hr><h2 id="一、项目整体结构" tabindex="-1">一、项目整体结构 <a class="header-anchor" href="#一、项目整体结构" aria-label="Permalink to &quot;一、项目整体结构&quot;">​</a></h2><h3 id="_1-1-目录结构" tabindex="-1">1.1 目录结构 <a class="header-anchor" href="#_1-1-目录结构" aria-label="Permalink to &quot;1.1 目录结构&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes material-theme-lighter material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">low-code-backend/</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">├──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> cmd/</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">                              # 应用程序入口</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   ├──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> api-server/</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">                   # 主API服务</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   │</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   └──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> main.go</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   ├──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> worker/</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">                       # 后台任务工作进程</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   │</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   └──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> main.go</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   └──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> migrate/</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">                      # 数据库迁移工具</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">       └──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> main.go</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">├──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> internal/</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">                         # 私有应用代码</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   ├──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> api/</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">                          # HTTP处理层</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   │</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   ├──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> handler/</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">                  # 请求处理器</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   │</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   │</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   ├──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> metadata/</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">             # 元数据处理器</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   │</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   │</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   ├──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> form/</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">                 # 表单处理器</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   │</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   │</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   ├──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> data/</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">                 # 数据处理器</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   │</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   │</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   ├──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> workflow/</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">             # 流程处理器</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   │</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   │</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   ├──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> auth/</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">                 # 认证处理器</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   │</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   │</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   └──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> system/</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">               # 系统处理器</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   │</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   ├──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> middleware/</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">               # 中间件</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   │</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   ├──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> router/</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">                   # 路由定义</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   │</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   └──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> dto/</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">                      # 数据传输对象</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   │</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   ├──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> service/</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">                      # 业务逻辑层</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   │</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   ├──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> metadata/</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   │</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   ├──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> form/</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   │</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   ├──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> data/</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   │</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   ├──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> workflow/</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   │</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   ├──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> rule/</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   │</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   ├──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> search/</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   │</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   └──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> auth/</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   │</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   ├──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> repository/</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">                   # 数据访问层</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   │</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   ├──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> postgres/</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   │</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   ├──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> elasticsearch/</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   │</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   └──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> redis/</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   │</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   ├──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> model/</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">                        # 数据模型</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   │</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   ├──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> entity/</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">                   # 实体模型</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   │</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   ├──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> domain/</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">                   # 领域模型</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   │</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   └──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> vo/</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">                       # 值对象</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   │</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   ├──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> engine/</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">                       # 引擎实现</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   │</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   ├──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> form/</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   │</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   ├──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> workflow/</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   │</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   └──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> rule/</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   │</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   └──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> task/</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">                         # 异步任务</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">├──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> pkg/</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">                              # 公共库</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   ├──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> database/</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   ├──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> redis/</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   ├──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> elasticsearch/</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   ├──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> logger/</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   ├──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> jwt/</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   ├──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> validator/</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   ├──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> utils/</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   └──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> config/</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">├──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> configs/</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">                          # 配置文件</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">├──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> scripts/</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">                          # 脚本</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">├──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> migrations/</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">                       # 数据库迁移</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">├──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> test/</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">                             # 测试</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">└──</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> api/</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">                              # API文档</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`\`\`</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">bash</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">### 1.2 分层架构设计</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`\`\`</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">bash</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">┌─────────────────────────────────────┐</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">      Handler</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 层</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> (HTTP处理)          │</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   -</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 参数绑定和校验</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">                  │</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   -</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 调用</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> Service</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 层</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">                 │</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   -</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 返回统一响应</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">                    │</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">└─────────────────────────────────────┘</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">              ↓</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">┌─────────────────────────────────────┐</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">      Service</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 层</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> (业务逻辑)          │</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   -</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 业务规则实现</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">                    │</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   -</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 事务控制</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">                        │</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   -</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 调用</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> Repository</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 层</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">              │</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">└─────────────────────────────────────┘</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">              ↓</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">┌─────────────────────────────────────┐</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">    Repository</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 层</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> (数据访问)         │</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   -</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> GORM</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 操作</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">                       │</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   -</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> Redis</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 缓存</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">                      │</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   -</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> ES</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 搜索</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">                         │</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">└─────────────────────────────────────┘</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">              ↓</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">┌─────────────────────────────────────┐</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">│</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">      数据层</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> (PostgreSQL/ES/Redis)   │</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">└─────────────────────────────────────┘</span></span></code></pre></div><hr><h2 id="二、gin-中间件体系" tabindex="-1">二、Gin 中间件体系 <a class="header-anchor" href="#二、gin-中间件体系" aria-label="Permalink to &quot;二、Gin 中间件体系&quot;">​</a></h2><h3 id="_2-1-中间件执行顺序" tabindex="-1">2.1 中间件执行顺序 <a class="header-anchor" href="#_2-1-中间件执行顺序" aria-label="Permalink to &quot;2.1 中间件执行顺序&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes material-theme-lighter material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">请求</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> →</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> Recovery</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> →</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> Logger</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> →</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> Trace</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> →</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> CORS</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> →</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> RateLimit</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> →</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> Auth</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> →</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> Permission</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> →</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> Handler</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> →</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 响应</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`\`\`</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">bash</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">### 2.2 核心中间件设计</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">#### 1. 认证中间件 (Auth)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">**</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">功能：</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">**</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">-</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> JWT Token 验证</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">-</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> Token 刷新机制</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">-</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 白名单路由（登录、注册等）</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">-</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 从 Redis 验证 Token 有效性（支持踢人下线）</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">**</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">执行流程：</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">**</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`\`\`</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">bash</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">1.</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 从</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> Header</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 提取</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> Authorization:</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> Bearer</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> {token}</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">2.</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 解析</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> JWT，获取</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> UserID</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 和过期时间</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">3.</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 从</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> Redis</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 检查</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> token:{userID}</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 是否存在且匹配</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">4.</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 验证通过，将用户信息注入到</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> gin.Context</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">5.</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 设置</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> UserID</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 到日志上下文</span></span></code></pre></div><p><strong>关键实现点：</strong></p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes material-theme-lighter material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">// 白名单路由（不需要认证）</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">var</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> whiteList </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">=</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> []</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">/api/v1/auth/login</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">/api/v1/auth/register</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">/api/v1/public/*</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">/health</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">// Redis Key 设计</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">lc</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">token</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:{</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">userID</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">}</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> -&gt;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">token_string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">}</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">TTL</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 7</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> days</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`\`\`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">bash</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">#### 2. 权限中间件 (Permission)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">**功能：**</span></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">- 基于 Casbin 实现 RBAC</span></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">- 检查用户是否有权限访问当前路由</span></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">- 支持路径参数匹配</span></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">- 支持 RESTful 风格</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">**执行流程：**</span></span></code></pre></div><ol><li>获取当前用户角色列表</li><li>获取请求路径和 HTTP 方法</li><li>Casbin.Enforce(role, path, method)</li><li>缓存权限检查结果（5分钟）</li></ol><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes material-theme-lighter material-theme-palenight vp-code" tabindex="0"><code><span class="line"></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">**</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Casbin 模型：</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">**</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`\`\`</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">ini</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">[</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">request_definition</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">]</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">r</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> = sub, obj, act</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">[</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">policy_definition</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">]</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">p</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> = sub, obj, act</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">[</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">role_definition</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">]</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">g</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> = _, _</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">[</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">policy_effect</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">]</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">e</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> = some</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">where</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> (p.eft == allow</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">[</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">matchers</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">]</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">m</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> = g</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">r.sub,</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> p.sub</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &amp;&amp;</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;"> keyMatch2(r.obj,</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> p.obj) </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&amp;&amp;</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;"> r.act</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> == p.act</span></span></code></pre></div><p><strong>策略示例：</strong></p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes material-theme-lighter material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">p,</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> admin,</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> /api/v1/pages/</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">*</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> *</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">p,</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> editor,</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> /api/v1/pages/</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">*</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">,</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> GET</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">p,</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> editor,</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> /api/v1/pages/</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">*</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">,</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> POST</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">g,</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> user:1001,</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> admin</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">g,</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> user:1002,</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> editor</span></span></code></pre></div><h4 id="_3-限流中间件-ratelimit" tabindex="-1">3. 限流中间件 (RateLimit) <a class="header-anchor" href="#_3-限流中间件-ratelimit" aria-label="Permalink to &quot;3. 限流中间件 (RateLimit)&quot;">​</a></h4><p><strong>功能：</strong></p><ul><li>IP 级别限流：100 req/min</li><li>用户级别限流：200 req/min</li><li>API 级别限流：特定接口自定义</li><li>返回 429 Too Many Requests</li></ul><p><strong>算法：滑动窗口（基于 Redis Sorted Set）</strong></p><p><strong>Redis Key 设计：</strong></p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes material-theme-lighter material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">lc:rate_limit:ip:</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">{ip}</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">             -</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&gt;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> Sorted</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> Set</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> (score=timestamp)</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">lc:rate_limit:user:</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">{userID}</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">       -</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&gt;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> Sorted</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> Set</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">lc:rate_limit:api:</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">{path}</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">:</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">{minute}</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> -</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&gt;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> String</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> (计数器)</span></span></code></pre></div><p><strong>实现逻辑：</strong></p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes material-theme-lighter material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">// 滑动窗口实现</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">func</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;"> checkRateLimit</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;">key</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;"> string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;"> limit</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;"> int64</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;"> window</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;"> time</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">Duration</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;"> bool</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    now </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> time</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Now</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">().</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Unix</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">()</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    windowStart </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> now </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">-</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;"> int64</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">window</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Seconds</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">())</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    pipe </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> rdb</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Pipeline</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">()</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">    // 删除窗口外的数据</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    pipe</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">ZRemRangeByScore</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">ctx</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> key</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">0</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> fmt</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Sprintf</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">%d</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> windowStart</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">))</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">    // 添加当前请求</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    pipe</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">ZAdd</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">ctx</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> key</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;"> redis</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">Z</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">{</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Score</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;"> float64</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">now</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">),</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> Member</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> now</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">})</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">    // 统计窗口内请求数</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    pipe</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">ZCount</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">ctx</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> key</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> fmt</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Sprintf</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">%d</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> windowStart</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">),</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> fmt</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Sprintf</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">%d</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> now</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">))</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">    // 设置过期时间</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    pipe</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Expire</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">ctx</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> key</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> window</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    results</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> _ </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> pipe</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Exec</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">ctx</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    count </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> results</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">[</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;">2</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">].(*</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">redis</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">IntCmd</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">).</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Val</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    return</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> count </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&lt;=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> limit</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">}</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`\`\`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">bash</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">#### 4. 日志中间件 (Logger)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">**功能：**</span></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">- 记录请求开始和结束</span></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">- 记录耗时、状态码、错误</span></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">- 记录 TraceID、UserID</span></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">- 慢查询警告（&gt;1s）</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">**日志格式（JSON）：**</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`\`\`</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">json</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">  &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">time</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">2024-01-01T12:00:00Z</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">  &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">level</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">info</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">  &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">trace_id</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">20240101120000-abc123</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">  &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">user_id</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 1001</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">  &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">method</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">POST</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">  &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">path</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">/api/v1/pages</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">  &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">query</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">status=draft</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">  &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">status</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 200</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">  &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">latency</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">45ms</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">  &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">ip</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">192.168.1.1</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">  &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">user_agent</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">Mozilla/5.0...</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">  &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">error</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">}</span></span></code></pre></div><p><strong>基于 Zap 实现：</strong></p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes material-theme-lighter material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">func</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;"> LoggerMiddleware</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;">logger</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> *</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">zap</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">Logger</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;"> gin</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">HandlerFunc</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    return</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> func(</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;">c</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> *</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">gin</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">Context</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        start </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> time</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Now</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">()</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        path </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> c</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Request</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">URL</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Path</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        query </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> c</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Request</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">URL</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">RawQuery</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        c</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Next</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        latency </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> time</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Since</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">start</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        status </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> c</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Writer</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Status</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        fields </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> []</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">zap</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">Field</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">            zap</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">String</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">trace_id</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> c</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">GetString</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">trace_id</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)),</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">            zap</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Int</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">user_id</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> c</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">GetInt</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">user_id</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)),</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">            zap</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">String</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">method</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> c</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Request</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Method</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">),</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">            zap</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">String</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">path</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> path</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">),</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">            zap</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">String</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">query</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> query</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">),</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">            zap</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Int</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">status</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> status</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">),</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">            zap</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Duration</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">latency</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> latency</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">),</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">            zap</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">String</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">ip</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> c</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">ClientIP</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">()),</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">        if</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> latency </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&gt;</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> time</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Second </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">            logger</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Warn</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">Slow request</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> fields</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">...)</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">        }</span><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> else</span><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> if</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> status </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&gt;=</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 500</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">            logger</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Error</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">Server error</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> fields</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">...)</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">        }</span><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> else</span><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> if</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> status </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&gt;=</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 400</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">            logger</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Warn</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">Client error</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> fields</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">...)</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">        }</span><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> else</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">            logger</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Info</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">Request completed</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> fields</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">...)</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">        }</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    }</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">}</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`\`\`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">bash</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">#### 5. 链路追踪 (Trace)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">**功能：**</span></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">- 每个请求生成唯一 TraceID</span></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">- 从 Header 读取 X-Trace-ID（支持分布式追踪）</span></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">- 注入到 Context 和响应 Header</span></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">- 传递给下游服务</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">**TraceID 格式：**</span></span></code></pre></div><p>{timestamp}-{randomString} 示例：20240101120000-abc123def456</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes material-theme-lighter material-theme-palenight vp-code" tabindex="0"><code><span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">#### 6. 异常恢复 (Recovery)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">**</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">功能：</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">**</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">-</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 捕获所有</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> panic</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">-</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 记录错误堆栈到日志</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">-</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 返回统一错误响应</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">-</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 发送告警（生产环境）</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">#### 7. CORS 中间件</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">**</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">配置：</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">**</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`\`\`</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">go</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">AllowOrigins:</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">     []string{</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">&quot;http://localhost:8080&quot;,</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">https://app.example.com</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">}</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">AllowMethods:</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">     []string{</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">&quot;GET&quot;,</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">POST</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">, </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">PUT</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">, </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">DELETE</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">, </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">OPTIONS</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">}</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">AllowHeaders:</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">     []string{</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">&quot;Origin&quot;,</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">Content-Type</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">, </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">Authorization</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">, </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">X-Trace-ID</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">}</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">AllowCredentials:</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> true</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">MaxAge:</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;">           12</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> *</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> time.Hour</span></span></code></pre></div><hr><h2 id="三、gorm-模型设计" tabindex="-1">三、GORM 模型设计 <a class="header-anchor" href="#三、gorm-模型设计" aria-label="Permalink to &quot;三、GORM 模型设计&quot;">​</a></h2><h3 id="_3-1-基础模型" tabindex="-1">3.1 基础模型 <a class="header-anchor" href="#_3-1-基础模型" aria-label="Permalink to &quot;3.1 基础模型&quot;">​</a></h3><h4 id="base-model" tabindex="-1">Base Model <a class="header-anchor" href="#base-model" aria-label="Permalink to &quot;Base Model&quot;">​</a></h4><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes material-theme-lighter material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">type</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;"> BaseModel</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> struct</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    ID        </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">uint</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">           \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;primarykey&quot; json:&quot;id&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    CreatedAt </span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">time</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">Time</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">      \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">json:&quot;created_at&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    UpdatedAt </span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">time</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">Time</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">      \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">json:&quot;updated_at&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    DeletedAt </span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">gorm</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">DeletedAt</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;index&quot; json:&quot;-&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;"> // 软删除</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">type</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;"> AuditModel</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> struct</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">    BaseModel</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    CreatedBy </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">uint</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">json:&quot;created_by&quot; gorm:&quot;index&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    UpdatedBy </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">uint</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">json:&quot;updated_by&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">}</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`\`\`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">bash</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">### 3.2 核心实体模型</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">#### 1. 页面模型</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`\`\`</span><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">go</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">type</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;"> Page</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> struct</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">    AuditModel</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Name        </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">         \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;size:100;not null;index&quot; json:&quot;name&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Code        </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">         \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;size:50;uniqueIndex&quot; json:&quot;code&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Route       </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">         \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;size:200;index&quot; json:&quot;route&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Config      </span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">datatypes</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">JSON</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;type:jsonb&quot; json:&quot;config&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Version     </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">int</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">            \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;default:1&quot; json:&quot;version&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Status      </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">         \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;size:20;default:&#39;draft&#39;;index&quot; json:&quot;status&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Description </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">         \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;size:500&quot; json:&quot;description&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Versions </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">[]</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">PageVersion</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;foreignKey:PageID&quot; json:&quot;versions,omitempty&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">func</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> (</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">Page</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;"> TableName</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">()</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;"> string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    return</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">lc_pages</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">}</span></span></code></pre></div><h4 id="_2-组件模型" tabindex="-1">2. 组件模型 <a class="header-anchor" href="#_2-组件模型" aria-label="Permalink to &quot;2. 组件模型&quot;">​</a></h4><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes material-theme-lighter material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">type</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;"> Component</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> struct</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">    BaseModel</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Type        </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">         \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;size:50;not null;uniqueIndex&quot; json:&quot;type&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Name        </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">         \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;size:100;not null&quot; json:&quot;name&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Category    </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">         \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;size:50;index&quot; json:&quot;category&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Icon        </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">         \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;size:100&quot; json:&quot;icon&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Schema      </span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">datatypes</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">JSON</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;type:jsonb;not null&quot; json:&quot;schema&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    DefaultProps </span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">datatypes</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">JSON</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;type:jsonb&quot; json:&quot;default_props&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    IsBuiltin   </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">bool</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">           \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;default:false;index&quot; json:&quot;is_builtin&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Sort        </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">int</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">            \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;default:0&quot; json:&quot;sort&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">}</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`\`\`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">bash</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">#### 3. 数据模型定义</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`\`\`</span><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">go</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">type</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;"> DataModel</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> struct</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">    AuditModel</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Name        </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">         \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;size:100;not null&quot; json:&quot;name&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Code        </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">         \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;size:50;uniqueIndex&quot; json:&quot;code&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    TableName   </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">         \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;size:100;uniqueIndex&quot; json:&quot;table_name&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Fields      </span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">datatypes</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">JSON</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;type:jsonb;not null&quot; json:&quot;fields&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Indexes     </span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">datatypes</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">JSON</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;type:jsonb&quot; json:&quot;indexes&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Relations   </span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">datatypes</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">JSON</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;type:jsonb&quot; json:&quot;relations&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Status      </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">         \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;size:20;default:&#39;active&#39;&quot; json:&quot;status&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">// Fields JSON 结构</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">type</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;"> FieldDefinition</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> struct</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Name         </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">      \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">json:&quot;name&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Type         </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">      \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">json:&quot;type&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Length       </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">int</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">         \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">json:&quot;length,omitempty&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Required     </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">bool</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">        \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">json:&quot;required&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    DefaultValue </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">interface{}</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">json:&quot;default_value,omitempty&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Unique       </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">bool</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">        \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">json:&quot;unique&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Index        </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">bool</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">        \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">json:&quot;index&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Comment      </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">      \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">json:&quot;comment&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">}</span></span></code></pre></div><h4 id="_4-工作流模型" tabindex="-1">4. 工作流模型 <a class="header-anchor" href="#_4-工作流模型" aria-label="Permalink to &quot;4. 工作流模型&quot;">​</a></h4><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes material-theme-lighter material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">type</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;"> WorkflowDefinition</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> struct</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">    AuditModel</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Name        </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">         \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;size:100;not null&quot; json:&quot;name&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Code        </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">         \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;size:50;uniqueIndex&quot; json:&quot;code&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    BpmnXML     </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">         \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;type:text&quot; json:&quot;bpmn_xml&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Config      </span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">datatypes</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">JSON</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;type:jsonb&quot; json:&quot;config&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Version     </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">int</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">            \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;default:1&quot; json:&quot;version&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Status      </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">         \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;size:20;default:&#39;draft&#39;&quot; json:&quot;status&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">type</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;"> WorkflowInstance</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> struct</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">    BaseModel</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    DefinitionID  </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">uint</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">           \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;index;not null&quot; json:&quot;definition_id&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    BusinessKey   </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">         \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;size:100;index&quot; json:&quot;business_key&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    CurrentNode   </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">         \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;size:100&quot; json:&quot;current_node&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Status        </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">         \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;size:20;index&quot; json:&quot;status&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Variables     </span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">datatypes</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">JSON</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;type:jsonb&quot; json:&quot;variables&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    StartedBy     </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">uint</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">           \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">json:&quot;started_by&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    StartedAt     </span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">time</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">Time</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">      \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">json:&quot;started_at&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    EndedAt       </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">*</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">time</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">Time</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">     \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">json:&quot;ended_at,omitempty&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">type</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;"> WorkflowTask</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> struct</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">    BaseModel</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    InstanceID  </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">uint</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">           \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;index;not null&quot; json:&quot;instance_id&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    NodeID      </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">         \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;size:100&quot; json:&quot;node_id&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    NodeName    </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">         \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;size:100&quot; json:&quot;node_name&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Assignee    </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">uint</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">           \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;index&quot; json:&quot;assignee&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Status      </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">         \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;size:20;index&quot; json:&quot;status&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    FormData    </span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">datatypes</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">JSON</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;type:jsonb&quot; json:&quot;form_data&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Comment     </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">         \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;size:1000&quot; json:&quot;comment&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    CompletedAt </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">*</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">time</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">Time</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">     \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">json:&quot;completed_at,omitempty&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">}</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`\`\`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">bash</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">#### 5. 用户和权限模型</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`\`\`</span><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">go</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">type</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;"> User</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> struct</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">    BaseModel</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Username     </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;size:50;uniqueIndex;not null&quot; json:&quot;username&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Password     </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;size:200;not null&quot; json:&quot;-&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Email        </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;size:100;uniqueIndex&quot; json:&quot;email&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Phone        </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;size:20&quot; json:&quot;phone&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    RealName     </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;size:50&quot; json:&quot;real_name&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Avatar       </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;size:500&quot; json:&quot;avatar&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Status       </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;size:20;default:&#39;active&#39;;index&quot; json:&quot;status&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    LastLoginAt  </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">*</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">time</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">Time</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">json:&quot;last_login_at,omitempty&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    LastLoginIP  </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;size:50&quot; json:&quot;last_login_ip&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Roles </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">[]</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">Role</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;many2many:lc_user_roles;&quot; json:&quot;roles,omitempty&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">type</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;"> Role</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> struct</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">    BaseModel</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Name        </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;size:50;uniqueIndex;not null&quot; json:&quot;name&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Code        </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;size:50;uniqueIndex;not null&quot; json:&quot;code&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Description </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;size:200&quot; json:&quot;description&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Sort        </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">int</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;default:0&quot; json:&quot;sort&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Users       </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">[]</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">User</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">       \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;many2many:lc_user_roles;&quot; json:&quot;users,omitempty&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Permissions </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">[]</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">Permission</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;many2many:lc_role_permissions;&quot; json:&quot;permissions,omitempty&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">type</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;"> Permission</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> struct</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">    BaseModel</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Resource    </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;size:100;not null&quot; json:&quot;resource&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Action      </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;size:20;not null&quot; json:&quot;action&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Description </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;size:200&quot; json:&quot;description&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Roles </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">[]</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">Role</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gorm:&quot;many2many:lc_role_permissions;&quot; json:&quot;roles,omitempty&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">}</span></span></code></pre></div><h3 id="_3-3-gorm-最佳实践" tabindex="-1">3.3 GORM 最佳实践 <a class="header-anchor" href="#_3-3-gorm-最佳实践" aria-label="Permalink to &quot;3.3 GORM 最佳实践&quot;">​</a></h3><h4 id="_1-连接池配置" tabindex="-1">1. 连接池配置 <a class="header-anchor" href="#_1-连接池配置" aria-label="Permalink to &quot;1. 连接池配置&quot;">​</a></h4><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes material-theme-lighter material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">sqlDB</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> _ </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> db</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">DB</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">()</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">sqlDB</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">SetMaxIdleConns</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;">10</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">           // 最小空闲连接</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">sqlDB</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">SetMaxOpenConns</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;">100</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">          // 最大打开连接</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">sqlDB</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">SetConnMaxLifetime</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">time</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Hour</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;"> // 连接最大生命周期</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`\`\`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">bash</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">#### 2. 预加载（避免 N+1）</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`\`\`</span><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">go</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">// 单层预加载</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">db</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Preload</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">Versions</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">).</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Find</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(&amp;</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">pages</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">// 嵌套预加载</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">db</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Preload</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">Tasks.Instance</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">).</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Find</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(&amp;</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">workflows</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">// 条件预加载</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">db</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Preload</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">Roles</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">status = ?</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">active</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">).</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Find</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(&amp;</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">users</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span></code></pre></div><h4 id="_3-批量操作" tabindex="-1">3. 批量操作 <a class="header-anchor" href="#_3-批量操作" aria-label="Permalink to &quot;3. 批量操作&quot;">​</a></h4><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes material-theme-lighter material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">// 批量插入</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">db</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">CreateInBatches</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">pages</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 100</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">// 批量更新</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">db</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Model</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(&amp;</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">Page</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">{}).</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Where</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">status = ?</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">draft</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">).</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Update</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">status</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">published</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`\`\`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">bash</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">#### 4. 事务处理</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`\`\`</span><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">go</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">// 自动事务</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">db</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Transaction</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(func(</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;">tx</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> *</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">gorm</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">DB</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;"> error</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    if</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> err </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> tx</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Create</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(&amp;</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">page</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">).</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Error</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">;</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> err </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">!=</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> nil</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">        return</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> err</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    }</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    if</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> err </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> tx</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Create</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(&amp;</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">version</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">).</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Error</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">;</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> err </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">!=</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> nil</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">        return</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> err</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    }</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    return</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> nil</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">})</span></span></code></pre></div><h4 id="_5-性能优化" tabindex="-1">5. 性能优化 <a class="header-anchor" href="#_5-性能优化" aria-label="Permalink to &quot;5. 性能优化&quot;">​</a></h4><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes material-theme-lighter material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">// 只查询需要的字段</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">db</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Select</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">id</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">name</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">status</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">).</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Find</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(&amp;</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">pages</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">// 分页优化（游标分页）</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">db</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Where</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">id &gt; ?</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> lastID</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">).</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Limit</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;">20</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">).</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Find</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(&amp;</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">pages</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">// 使用索引</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">db</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Clauses</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">hint</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">UseIndex</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">idx_page_status</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)).</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Find</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(&amp;</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">pages</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`\`\`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">bash</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">---</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">## 四、Redis 缓存策略</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">### 4.1 go-redis 客户端配置</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`\`\`</span><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">go</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">// 单机模式</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">rdb </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> redis</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">NewClient</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(&amp;</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">redis</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">Options</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Addr</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">         &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">localhost:6379</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Password</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">     &quot;&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    DB</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;">           0</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    PoolSize</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;">     20</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    MinIdleConns</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 5</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    MaxRetries</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;">   3</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    DialTimeout</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;">  5</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> *</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> time</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Second</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    ReadTimeout</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;">  3</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> *</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> time</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Second</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    WriteTimeout</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 3</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> *</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> time</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Second</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">})</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">// 集群模式</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">rdb </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> redis</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">NewClusterClient</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(&amp;</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">redis</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">ClusterOptions</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Addrs</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    []</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">{</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">node1:7000</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">node2:7001</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">node3:7002</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">},</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    PoolSize</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 20</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">})</span></span></code></pre></div><h3 id="_4-2-key-设计规范" tabindex="-1">4.2 Key 设计规范 <a class="header-anchor" href="#_4-2-key-设计规范" aria-label="Permalink to &quot;4.2 Key 设计规范&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes material-theme-lighter material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">格式：项目前缀:模块:业务:ID:字段</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">示例：</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">lc:user:info:1001</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">              -</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 用户信息</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">lc:page:config:home</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">            -</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 页面配置</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">lc:metadata:component:list</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">     -</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 组件列表</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">lc:token:1001</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">                  -</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 用户Token</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">lc:lock:page:1001</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">              -</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 分布式锁</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">lc:rate_limit:ip:192.168.1.1</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">   -</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 限流计数</span></span></code></pre></div><h3 id="_4-3-核心应用场景" tabindex="-1">4.3 核心应用场景 <a class="header-anchor" href="#_4-3-核心应用场景" aria-label="Permalink to &quot;4.3 核心应用场景&quot;">​</a></h3><h4 id="_1-元数据配置缓存" tabindex="-1">1. 元数据配置缓存 <a class="header-anchor" href="#_1-元数据配置缓存" aria-label="Permalink to &quot;1. 元数据配置缓存&quot;">​</a></h4><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes material-theme-lighter material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">场景：页面配置、组件定义（读多写少）</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">数据结构：String</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> (JSON) 或 Hash</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">TTL：1</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> hour</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">缓存策略：Cache-Aside</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">Key</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 设计：</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">lc:page:config:</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">{pageID}</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">lc:component:schema:</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">{componentType}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">更新策略：</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">1.</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 读取：Redis</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> →</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> DB</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> →</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> Redis</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">2.</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 更新：DB</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> →</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> Delete</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> Redis（延迟双删）</span></span></code></pre></div><h4 id="_2-用户会话管理" tabindex="-1">2. 用户会话管理 <a class="header-anchor" href="#_2-用户会话管理" aria-label="Permalink to &quot;2. 用户会话管理&quot;">​</a></h4><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes material-theme-lighter material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">场景：JWT</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> Token</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 验证、在线用户</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">数据结构：String</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">Token</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 存储：</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">lc:token:</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">{userID}</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> -</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&gt;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> token_string</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">TTL:</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 7</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> days</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">Token</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 黑名单：</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">lc:token:blacklist:</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">{token}</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> -</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&gt;</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 1</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">TTL:</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 剩余有效期</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">在线用户：</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">lc:online:users</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> -</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&gt;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> Set</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> {userID1,</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> userID2}</span></span></code></pre></div><h4 id="_3-分布式锁" tabindex="-1">3. 分布式锁 <a class="header-anchor" href="#_3-分布式锁" aria-label="Permalink to &quot;3. 分布式锁&quot;">​</a></h4><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes material-theme-lighter material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">场景：并发控制（如同一页面多人编辑）</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">实现：SET</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> NX</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> EX</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">Key</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 设计：</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">lc:lock:page:edit:</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">{pageID}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">使用</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> Lua</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 脚本保证原子性：</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">-</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 获取锁：SET</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> key</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> value</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> NX</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> EX</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 30</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">-</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 释放锁：只能释放自己的锁（检查</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> value）</span></span></code></pre></div><h4 id="_4-限流计数器" tabindex="-1">4. 限流计数器 <a class="header-anchor" href="#_4-限流计数器" aria-label="Permalink to &quot;4. 限流计数器&quot;">​</a></h4><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes material-theme-lighter material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">场景：API</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 限流、防刷</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">算法：滑动窗口（Sorted</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> Set）</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">Key</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 设计：</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">lc:rate_limit:ip:</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">{ip}</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">lc:rate_limit:user:</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">{userID}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">实现：ZAdd</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> +</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> ZCount</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> +</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> ZRemRangeByScore</span></span></code></pre></div><h4 id="_5-查询结果缓存" tabindex="-1">5. 查询结果缓存 <a class="header-anchor" href="#_5-查询结果缓存" aria-label="Permalink to &quot;5. 查询结果缓存&quot;">​</a></h4><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes material-theme-lighter material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">场景：复杂查询、聚合统计</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">数据结构：String</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> (JSON)</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">TTL：5-10</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> minutes</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">Key</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 设计：</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">lc:cache:query:</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">{</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">hash</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">(</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">params</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">)}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">防护措施：</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">-</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 缓存击穿：互斥锁</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">-</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 缓存穿透：空值缓存</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> +</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 布隆过滤器</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">-</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 缓存雪崩：过期时间加随机值</span></span></code></pre></div><h4 id="_6-消息队列-stream" tabindex="-1">6. 消息队列 (Stream) <a class="header-anchor" href="#_6-消息队列-stream" aria-label="Permalink to &quot;6. 消息队列 (Stream)&quot;">​</a></h4><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes material-theme-lighter material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">场景：异步任务、事件溯源</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">数据结构：Stream</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">Stream</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 设计：</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">lc:stream:data:sync</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">lc:stream:file:export</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">使用消费者组：</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">XGROUP</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> CREATE</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">XREADGROUP</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">XACK</span></span></code></pre></div><h3 id="_4-4-缓存最佳实践" tabindex="-1">4.4 缓存最佳实践 <a class="header-anchor" href="#_4-4-缓存最佳实践" aria-label="Permalink to &quot;4.4 缓存最佳实践&quot;">​</a></h3><h4 id="缓存更新策略" tabindex="-1">缓存更新策略 <a class="header-anchor" href="#缓存更新策略" aria-label="Permalink to &quot;缓存更新策略&quot;">​</a></h4><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes material-theme-lighter material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">1.</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> Cache-Aside（旁路缓存）-</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 推荐</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">   读：缓存</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> →</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> DB</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> →</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 写缓存</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">   写：DB</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> →</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 删除缓存</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">2.</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> Write-Through（直写）</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">   写：同时写</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> DB</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 和缓存</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">3.</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> Write-Behind（回写）</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">   写：先写缓存，异步写</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> DB</span></span></code></pre></div><h4 id="过期时间设置" tabindex="-1">过期时间设置 <a class="header-anchor" href="#过期时间设置" aria-label="Permalink to &quot;过期时间设置&quot;">​</a></h4><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes material-theme-lighter material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">元数据配置：1-2</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 小时</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">用户会话：7</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 天</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">查询结果：5-10</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 分钟</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">热点数据：永不过期</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> +</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 逻辑过期</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">临时数据：1-5</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 分钟</span></span></code></pre></div><h4 id="pipeline-批量操作" tabindex="-1">Pipeline 批量操作 <a class="header-anchor" href="#pipeline-批量操作" aria-label="Permalink to &quot;Pipeline 批量操作&quot;">​</a></h4><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes material-theme-lighter material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">pipe </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> rdb</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Pipeline</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">()</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">for</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> _</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> page </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> range</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> pages </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    key </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> fmt</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Sprintf</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">lc:page:config:</span><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">%d</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> page</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">ID</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    pipe</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Set</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">ctx</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> key</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> page</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Config</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> time</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Hour</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">}</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">_</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> err </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> pipe</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Exec</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">ctx</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`\`\`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">bash</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">---</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">## 五、API 接口规范</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">### 5.1 RESTful 风格</span></span></code></pre></div><p>GET /api/v1/pages - 获取页面列表 GET /api/v1/pages/:id - 获取单个页面 POST /api/v1/pages - 创建页面 PUT /api/v1/pages/:id - 更新页面 DELETE /api/v1/pages/:id - 删除页面</p><p>GET /api/v1/pages/:id/versions - 获取页面版本列表 POST /api/v1/pages/:id/publish - 发布页面 POST /api/v1/pages/:id/rollback/:ver - 回滚到指定版本</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes material-theme-lighter material-theme-palenight vp-code" tabindex="0"><code><span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">### 5.2 统一响应格式</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">#### 成功响应</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`\`\`</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">json</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">  &quot;code&quot;</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">:</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 0,</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">  &quot;message&quot;</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">:</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">success</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">,</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">  &quot;data&quot;</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">:</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> {</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">    &quot;id&quot;</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">:</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 1001,</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">    &quot;name&quot;</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">:</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">首页</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">  }</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">,</span></span>
<span class="line"><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">  &quot;trace_id&quot;</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">:</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">20240101120000-abc123</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">}</span></span></code></pre></div><h4 id="分页响应" tabindex="-1">分页响应 <a class="header-anchor" href="#分页响应" aria-label="Permalink to &quot;分页响应&quot;">​</a></h4><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes material-theme-lighter material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">  &quot;</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">code</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 0</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">  &quot;</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">message</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">success</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">  &quot;</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">data</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    &quot;</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">list</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> [</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">...</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">],</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    &quot;</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">pagination</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">      &quot;</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;">page</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 1</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">      &quot;</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;">page_size</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 20</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">      &quot;</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;">total</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 100</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">      &quot;</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;">total_pages</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 5</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    }</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">  },</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">  &quot;</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">trace_id</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">20240101120000-abc123</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">}</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">\`\`\`bash</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">#### 错误响应</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">\`\`\`json</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">  &quot;</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">code</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 40001</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">  &quot;</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">message</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">页面不存在</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">  &quot;</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">error</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">page not found</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">  &quot;</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">trace_id</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">20240101120000-abc123</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">}</span></span></code></pre></div><h3 id="_5-3-错误码设计" tabindex="-1">5.3 错误码设计 <a class="header-anchor" href="#_5-3-错误码设计" aria-label="Permalink to &quot;5.3 错误码设计&quot;">​</a></h3><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes material-theme-lighter material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">const</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> (</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    ErrSuccess        </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">=</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 0</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">      // 成功</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">    // 1xxxx 通用错误</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    ErrInternalServer </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">=</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 10000</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">  // 服务器内部错误</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    ErrInvalidParams  </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">=</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 10001</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">  // 参数错误</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    ErrUnauthorized   </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">=</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 10002</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">  // 未认证</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    ErrForbidden      </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">=</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 10003</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">  // 无权限</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    ErrNotFound       </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">=</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 10004</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">  // 资源不存在</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">    // 2xxxx 用户相关</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    ErrUserNotFound      </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">=</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 20001</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    ErrUserAlreadyExists </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">=</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 20002</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    ErrPasswordIncorrect </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">=</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 20003</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">    // 3xxxx 页面相关</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    ErrPageNotFound      </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">=</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 30001</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    ErrPageAlreadyExists </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">=</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 30002</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    ErrPageInvalidConfig </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">=</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 30003</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">    // 4xxxx 数据相关</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    ErrDataModelNotFound </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">=</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 40001</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    ErrDataValidationFailed </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">=</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 40002</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`\`\`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">bash</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">### 5.4 路由分组设计</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`\`\`</span><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">go</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">api </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> r</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Group</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">/api/v1</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">api</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Use</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">middleware</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Auth</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(),</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> middleware</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Permission</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">())</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">    // 元数据管理</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    metadata </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> api</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Group</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">/metadata</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    {</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        metadata</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">GET</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">/pages</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> handler</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">ListPages</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        metadata</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">POST</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">/pages</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> handler</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">CreatePage</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        metadata</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">GET</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">/pages/:id</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> handler</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">GetPage</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        metadata</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">PUT</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">/pages/:id</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> handler</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">UpdatePage</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        metadata</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">DELETE</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">/pages/:id</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> handler</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">DeletePage</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        metadata</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">GET</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">/components</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> handler</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">ListComponents</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        metadata</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">POST</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">/components</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> handler</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">CreateComponent</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        metadata</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">GET</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">/models</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> handler</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">ListDataModels</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        metadata</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">POST</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">/models</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> handler</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">CreateDataModel</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">    // 表单</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    form </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> api</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Group</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">/form</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    {</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        form</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">GET</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">/designs/:id</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> handler</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">GetFormDesign</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        form</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">POST</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">/designs</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> handler</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">CreateFormDesign</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        form</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">POST</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">/validate</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> handler</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">ValidateForm</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">    // 动态数据</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    data </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> api</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Group</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">/data</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    {</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        data</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">GET</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">/:model</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> handler</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">QueryData</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        data</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">POST</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">/:model</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> handler</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">CreateData</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        data</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">GET</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">/:model/:id</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> handler</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">GetData</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        data</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">PUT</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">/:model/:id</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> handler</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">UpdateData</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        data</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">DELETE</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">/:model/:id</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> handler</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">DeleteData</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">    // 工作流</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    workflow </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> api</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Group</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">/workflow</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    {</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        workflow</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">GET</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">/definitions</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> handler</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">ListWorkflowDefinitions</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        workflow</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">POST</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">/definitions</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> handler</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">CreateWorkflowDefinition</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        workflow</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">POST</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">/instances</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> handler</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">StartWorkflowInstance</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        workflow</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">GET</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">/tasks/my</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> handler</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">GetMyTasks</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        workflow</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">POST</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">/tasks/:id/complete</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> handler</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">CompleteTask</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">    // 认证授权</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    auth </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> api</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Group</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">/auth</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    {</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        auth</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">POST</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">/login</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> handler</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Login</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        auth</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">POST</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">/logout</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> handler</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Logout</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        auth</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">POST</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">/refresh</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> handler</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">RefreshToken</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        auth</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">GET</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">/me</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> handler</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">GetCurrentUser</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">    // 系统管理</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    system </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> api</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Group</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">/system</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    {</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        system</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">GET</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">/users</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> handler</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">ListUsers</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        system</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">POST</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">/users</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> handler</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">CreateUser</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        system</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">GET</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">/roles</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> handler</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">ListRoles</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        system</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">POST</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">/roles</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> handler</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">CreateRole</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        system</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">GET</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">/permissions</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> handler</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">ListPermissions</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    }</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">}</span></span></code></pre></div><hr><h2 id="六、核心服务实现方案" tabindex="-1">六、核心服务实现方案 <a class="header-anchor" href="#六、核心服务实现方案" aria-label="Permalink to &quot;六、核心服务实现方案&quot;">​</a></h2><h3 id="_6-1-元数据服务-metadata-service" tabindex="-1">6.1 元数据服务 (Metadata Service) <a class="header-anchor" href="#_6-1-元数据服务-metadata-service" aria-label="Permalink to &quot;6.1 元数据服务 (Metadata Service)&quot;">​</a></h3><h4 id="职责" tabindex="-1">职责 <a class="header-anchor" href="#职责" aria-label="Permalink to &quot;职责&quot;">​</a></h4><ul><li>管理页面配置、组件定义、数据模型</li><li>版本管理和回滚</li><li>配置校验</li></ul><h4 id="核心功能" tabindex="-1">核心功能 <a class="header-anchor" href="#核心功能" aria-label="Permalink to &quot;核心功能&quot;">​</a></h4><p><strong>1. 页面配置管理</strong></p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes material-theme-lighter material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">// Service 层</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">type</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;"> PageService</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> struct</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    pageRepo    </span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">repository</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">PageRepository</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    cacheRepo   </span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">repository</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">CacheRepository</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    versionRepo </span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">repository</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">PageVersionRepository</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">// 创建页面</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">func</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> (</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;">s </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">*</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">PageService</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;"> CreatePage</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;">req</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> *</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">dto</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">CreatePageRequest</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> (*</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">entity</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">Page</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;"> error</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">    // 1. 校验配置 JSON Schema</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    if</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> err </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> s</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">validatePageConfig</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">req</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Config</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">);</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> err </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">!=</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> nil</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">        return</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> nil,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> err</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">    // 2. 检查 Code 唯一性</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    exists</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> _ </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> s</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">pageRepo</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">ExistsByCode</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">req</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Code</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    if</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> exists </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">        return</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> nil,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> errors</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">ErrPageAlreadyExists</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">    // 3. 保存页面</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    page </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &amp;</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">entity</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">Page</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        Name</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">   req</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Name</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        Code</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">   req</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Code</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        Config</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> req</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Config</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        Version</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 1</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        Status</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">draft</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">    // 4. 事务：保存页面 + 创建版本记录</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    err </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> s</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">pageRepo</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Transaction</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(func(</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;">tx</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> *</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">gorm</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">DB</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;"> error</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">        if</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> err </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> s</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">pageRepo</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Create</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">tx</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> page</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">);</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> err </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">!=</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> nil</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">            return</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> err</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        version </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &amp;</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">entity</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">PageVersion</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">            PageID</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">  page</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">ID</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">            Version</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 1</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">            Config</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">  req</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Config</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">        }</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">        return</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> s</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">versionRepo</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Create</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">tx</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> version</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    })</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    return</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> page</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> err</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">// 发布页面</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">func</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> (</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;">s </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">*</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">PageService</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;"> PublishPage</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;">pageID</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;"> uint</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;"> error</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">    // 1. 更新状态</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    if</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> err </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> s</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">pageRepo</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">UpdateStatus</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">pageID</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">published</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">);</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> err </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">!=</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> nil</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">        return</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> err</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">    // 2. 清除缓存</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    cacheKey </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> fmt</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Sprintf</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">lc:page:config:</span><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">%d</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> pageID</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    s</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">cacheRepo</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Delete</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">cacheKey</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">    // 3. 发送事件（通知前端刷新）</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    s</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">publishEvent</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">page.published</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> pageID</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    return</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> nil</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">// 获取页面（带缓存）</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">func</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> (</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;">s </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">*</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">PageService</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;"> GetPage</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;">id</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;"> uint</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> (*</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">entity</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">Page</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;"> error</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    cacheKey </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> fmt</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Sprintf</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">lc:page:config:</span><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">%d</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> id</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">    // 1. 尝试从缓存读取</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    var</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> page </span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">entity</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">Page</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    if</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> err </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> s</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">cacheRepo</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Get</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">cacheKey</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &amp;</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">page</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">);</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> err </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">==</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> nil</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">        return</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &amp;</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">page</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> nil</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">    // 2. 从数据库读取</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    page</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> err </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> s</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">pageRepo</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">FindByID</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">id</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    if</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> err </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">!=</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> nil</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">        return</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> nil,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> err</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">    // 3. 写入缓存</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    s</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">cacheRepo</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Set</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">cacheKey</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> page</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> time</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Hour</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    return</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> page</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> nil</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">}</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`\`\`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">bash</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">**2. 版本管理**</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`\`\`</span><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">go</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">// 创建新版本</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">func</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> (</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;">s </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">*</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">PageService</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;"> CreateVersion</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;">pageID</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;"> uint</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;"> config</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;"> json</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">RawMessage</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;"> changeLog</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;"> string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;"> error</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    page</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> _ </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> s</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">pageRepo</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">FindByID</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">pageID</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    newVersion </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> page</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Version </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">+</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 1</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    return</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> s</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">pageRepo</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Transaction</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(func(</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;">tx</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> *</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">gorm</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">DB</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;"> error</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">        // 更新页面版本号</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        s</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">pageRepo</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">UpdateVersion</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">tx</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> pageID</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> newVersion</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">        // 创建版本记录</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        version </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &amp;</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">entity</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">PageVersion</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">            PageID</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    pageID</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">            Version</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">   newVersion</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">            Config</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    config</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">            ChangeLog</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> changeLog</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">        }</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">        return</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> s</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">versionRepo</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Create</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">tx</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> version</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    })</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">// 回滚到指定版本</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">func</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> (</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;">s </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">*</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">PageService</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;"> RollbackToVersion</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;">pageID</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;"> uint</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;"> version</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;"> int</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;"> error</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">    // 1. 获取历史版本</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    historyVersion</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> err </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> s</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">versionRepo</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">FindByPageIDAndVersion</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">pageID</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> version</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    if</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> err </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">!=</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> nil</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">        return</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> err</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">    // 2. 更新当前页面配置</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    return</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> s</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">pageRepo</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">UpdateConfig</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">pageID</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> historyVersion</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Config</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">}</span></span></code></pre></div><h3 id="_6-2-表单引擎服务-form-engine-service" tabindex="-1">6.2 表单引擎服务 (Form Engine Service) <a class="header-anchor" href="#_6-2-表单引擎服务-form-engine-service" aria-label="Permalink to &quot;6.2 表单引擎服务 (Form Engine Service)&quot;">​</a></h3><h4 id="职责-1" tabindex="-1">职责 <a class="header-anchor" href="#职责-1" aria-label="Permalink to &quot;职责&quot;">​</a></h4><ul><li>动态表单配置管理</li><li>表单校验引擎</li><li>表单联动逻辑</li></ul><h4 id="核心功能-1" tabindex="-1">核心功能 <a class="header-anchor" href="#核心功能-1" aria-label="Permalink to &quot;核心功能&quot;">​</a></h4><p><strong>1. 表单配置结构</strong></p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes material-theme-lighter material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">type</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;"> FormSchema</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> struct</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    FormID   </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">         \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">json:&quot;form_id&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Layout   </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">         \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">json:&quot;layout&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">    // horizontal/vertical/inline</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Fields   </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">[]</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">FormField</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">json:&quot;fields&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Rules    </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">[]</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">LinkageRule</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">  \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">json:&quot;rules&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">     // 联动规则</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">type</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;"> FormField</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> struct</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Key         </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">                 \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">json:&quot;key&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Type        </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">                 \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">json:&quot;type&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">        // input/select/date...</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Label       </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">                 \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">json:&quot;label&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Rules       </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">[]</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">ValidationRule</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">       \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">json:&quot;rules&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Props       </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">map[</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">]interface{}</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">json:&quot;props&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Visible     </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">                 \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">json:&quot;visible&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">     // 表达式</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Disabled    </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">                 \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">json:&quot;disabled&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">    // 表达式</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    DefaultValue </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">interface{}</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">           \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">json:&quot;default_value&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">type</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;"> ValidationRule</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> struct</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Type     </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">      \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">json:&quot;type&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">      // required/pattern/custom</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Message  </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">      \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">json:&quot;message&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Pattern  </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">      \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">json:&quot;pattern,omitempty&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Validator </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">     \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">json:&quot;validator,omitempty&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;"> // 自定义校验函数名</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">type</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;"> LinkageRule</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> struct</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Condition </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">                 \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">json:&quot;condition&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;"> // 表达式</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Actions   </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">[]</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">LinkageAction</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">        \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">json:&quot;actions&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">type</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;"> LinkageAction</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> struct</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Type   </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">      \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">json:&quot;type&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">   // setValue/setVisible/setDisabled</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Target </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">      \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">json:&quot;target&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;"> // 目标字段</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Value  </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">interface{}</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">json:&quot;value&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">}</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`\`\`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">bash</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">**2. 表单校验引擎**</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`\`\`</span><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">go</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">type</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;"> FormValidator</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> struct</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    evaluator </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">*</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">rule</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">Evaluator</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;"> // 表达式求值器</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">// 校验表单数据</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">func</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> (</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;">v </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">*</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">FormValidator</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;"> Validate</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;">schema</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> *</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">FormSchema</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;"> data</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> map[</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">]interface{})</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;"> error</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    var</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> errors </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">[]</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    for</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> _</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> field </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> range</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> schema</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Fields </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        value </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> data</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">[</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">field</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Key</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">        // 1. 检查字段是否可见（不可见字段不校验）</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">        if</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> field</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Visible </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">!=</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">            visible</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> _ </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> v</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">evaluator</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Eval</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">field</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Visible</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> data</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">            if</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> !</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">visible</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.(</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">bool</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">                continue</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">            }</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">        // 2. 执行校验规则</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">        for</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> _</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> rule </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> range</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> field</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Rules </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">            if</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> err </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> v</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">validateRule</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">field</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> value</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> rule</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> data</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">);</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> err </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">!=</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> nil</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">                errors </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">=</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;"> append</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">errors</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> err</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Error</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">())</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">            }</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">        }</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    if</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;"> len</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">errors</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &gt;</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 0</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">        return</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> fmt</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Errorf</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">validation failed: </span><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">%s</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> strings</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Join</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">errors</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">; </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">))</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    }</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    return</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> nil</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">// 执行单条校验规则</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">func</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> (</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;">v </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">*</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">FormValidator</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;"> validateRule</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;">field</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;"> FormField</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;"> value</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> interface{},</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;"> rule</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;"> ValidationRule</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;"> data</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> map[</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">]interface{})</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;"> error</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    switch</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> rule</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Type </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    case</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">required</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">        if</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> value </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">==</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> nil</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> ||</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> value </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">==</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">            return</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> fmt</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Errorf</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">%s</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">: </span><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">%s</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> field</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Label</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> rule</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Message</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">        }</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    case</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">pattern</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        matched</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> _ </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> regexp</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">MatchString</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">rule</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Pattern</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> fmt</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Sprintf</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">%v</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> value</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">))</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">        if</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> !</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">matched </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">            return</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> fmt</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Errorf</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">%s</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">: </span><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">%s</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> field</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Label</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> rule</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Message</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">        }</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    case</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">custom</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">        // 执行自定义校验函数</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">        if</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> !</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">v</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">executeCustomValidator</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">rule</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Validator</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> value</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> data</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">            return</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> fmt</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Errorf</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">%s</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">: </span><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">%s</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> field</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Label</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> rule</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Message</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">        }</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    }</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    return</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> nil</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">}</span></span></code></pre></div><p><strong>3. 表单联动引擎</strong></p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes material-theme-lighter material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">// 计算联动结果</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">func</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> (</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;">e </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">*</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">FormEngine</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;"> ComputeLinkage</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;">schema</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> *</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">FormSchema</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;"> data</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> map[</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">]interface{})</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> map[</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">]interface{}</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    result </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;"> make</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(map[</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">]interface{})</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    for</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> _</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> rule </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> range</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> schema</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Rules </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">        // 判断条件是否满足</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        conditionMet</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> _ </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> e</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">evaluator</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Eval</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">rule</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Condition</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> data</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">        if</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> !</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">conditionMet</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.(</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">bool</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">            continue</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">        // 执行动作</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">        for</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> _</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> action </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> range</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> rule</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Actions </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">            switch</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> action</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Type </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">            case</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">setValue</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">                result</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">[</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">action</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Target</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">]</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> action</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Value</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">            case</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">setVisible</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">                key </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> fmt</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Sprintf</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">_visible_</span><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">%s</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> action</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Target</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">                result</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">[</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">key</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">]</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> action</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Value</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">            case</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">setDisabled</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">                key </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> fmt</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Sprintf</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">_disabled_</span><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">%s</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> action</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Target</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">                result</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">[</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">key</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">]</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> action</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Value</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">            }</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">        }</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    return</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> result</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">}</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`\`\`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">bash</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">### 6.3 动态数据服务 (Dynamic Data Service)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">#### 职责</span></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">- 基于元数据的通用 CRUD</span></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">- 动态查询构建</span></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">- 数据权限过滤</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">#### 核心功能</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">**1. 通用 CRUD 接口**</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`\`\`</span><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">go</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">type</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;"> DynamicDataService</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> struct</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    modelRepo </span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">repository</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">DataModelRepository</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    db        </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">*</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">gorm</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">DB</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">// 创建数据</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">func</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> (</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;">s </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">*</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">DynamicDataService</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;"> Create</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;">modelCode</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;"> string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;"> data</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> map[</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">]interface{})</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> (</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">uint</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;"> error</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">    // 1. 获取数据模型定义</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    model</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> err </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> s</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">modelRepo</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">FindByCode</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">modelCode</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    if</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> err </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">!=</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> nil</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">        return</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 0</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> err</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">    // 2. 数据校验</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    if</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> err </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> s</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">validateData</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">model</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> data</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">);</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> err </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">!=</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> nil</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">        return</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 0</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> err</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">    // 3. 插入数据</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    tableName </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> model</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">TableName</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">    // 构建插入 SQL</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    columns </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> []</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">{}</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    placeholders </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> []</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">{}</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    values </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> []interface{}{}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    for</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> _</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> field </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> range</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> model</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Fields </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">        if</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> value</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> ok </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> data</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">[</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">field</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Name</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">];</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> ok </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">            columns </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">=</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;"> append</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">columns</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> field</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Name</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">            placeholders </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">=</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;"> append</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">placeholders</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">?</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">            values </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">=</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;"> append</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">values</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> value</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">        }</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    sql </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> fmt</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Sprintf</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">INSERT INTO </span><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">%s</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> (</span><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">%s</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">) VALUES (</span><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">%s</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">) RETURNING id</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        tableName</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        strings</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Join</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">columns</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">, </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">),</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        strings</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Join</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">placeholders</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">, </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">))</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    var</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> id </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">uint</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    err </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> s</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">db</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Raw</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">sql</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> values</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">...).</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Scan</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(&amp;</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">id</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">).</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Error</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    return</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> id</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> err</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">// 查询数据（支持复杂条件）</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">func</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> (</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;">s </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">*</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">DynamicDataService</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;"> Query</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;">modelCode</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;"> string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;"> query</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> *</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">dto</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">QueryRequest</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> (*</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">dto</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">QueryResponse</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;"> error</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    model</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> _ </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> s</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">modelRepo</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">FindByCode</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">modelCode</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">    // 构建查询</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    qb </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;"> NewQueryBuilder</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">s</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">db</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> model</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">TableName</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">    // 添加过滤条件</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    for</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> _</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> filter </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> range</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> query</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Filters </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        qb</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">AddFilter</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">filter</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">    // 添加排序</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    for</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> _</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> sort </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> range</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> query</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Sorts </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        qb</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">AddSort</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">sort</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Field</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> sort</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Order</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">    // 分页</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    qb</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Paginate</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">query</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Page</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> query</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">PageSize</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">    // 执行查询</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    var</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> results </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">[]map[</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">]interface{}</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    var</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> total </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">int64</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    qb</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Find</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(&amp;</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">results</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    qb</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Count</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(&amp;</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">total</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    return</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &amp;</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">dto</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">QueryResponse</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        List</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> results</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        Pagination</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;"> dto</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">Pagination</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">            Page</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">       query</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Page</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">            PageSize</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">   query</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">PageSize</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">            Total</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">      total</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">            TotalPages</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;"> int</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">math</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Ceil</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">float64</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">total</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> /</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;"> float64</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">query</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">PageSize</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">))),</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">        },</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    },</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> nil</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">}</span></span></code></pre></div><p><strong>2. 查询构建器</strong></p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes material-theme-lighter material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">type</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;"> QueryBuilder</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> struct</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    db        </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">*</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">gorm</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">DB</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    tableName </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">type</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;"> Filter</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> struct</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Field    </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">      \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">json:&quot;field&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Operator </span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">      \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">json:&quot;operator&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;"> // eq/ne/gt/lt/like/in/between</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    Value    </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">interface{}</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> \`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">json:&quot;value&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">func</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> (</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;">qb </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">*</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">QueryBuilder</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;"> AddFilter</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;">filter</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;"> Filter</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    switch</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> filter</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Operator </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    case</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">eq</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        qb</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">db </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> qb</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">db</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Where</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">fmt</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Sprintf</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">%s</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> = ?</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> filter</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Field</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">),</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> filter</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Value</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    case</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">ne</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        qb</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">db </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> qb</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">db</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Where</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">fmt</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Sprintf</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">%s</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> != ?</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> filter</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Field</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">),</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> filter</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Value</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    case</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">gt</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        qb</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">db </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> qb</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">db</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Where</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">fmt</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Sprintf</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">%s</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> &gt; ?</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> filter</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Field</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">),</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> filter</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Value</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    case</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">lt</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        qb</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">db </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> qb</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">db</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Where</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">fmt</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Sprintf</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">%s</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> &lt; ?</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> filter</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Field</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">),</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> filter</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Value</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    case</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">like</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        qb</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">db </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> qb</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">db</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Where</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">fmt</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Sprintf</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">%s</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> LIKE ?</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> filter</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Field</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">),</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> fmt</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Sprintf</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">%%%v%%</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> filter</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Value</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">))</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    case</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">in</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        qb</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">db </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> qb</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">db</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Where</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">fmt</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Sprintf</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">%s</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> IN ?</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> filter</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Field</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">),</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> filter</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Value</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    case</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">between</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        values </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> filter</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Value</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.([]interface{})</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">        qb</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">db </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> qb</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">db</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Where</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">fmt</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Sprintf</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">%s</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> BETWEEN ? AND ?</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> filter</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Field</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">),</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> values</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">[</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;">0</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">],</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> values</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">[</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;">1</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">])</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    }</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">func</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> (</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;">qb </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">*</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">QueryBuilder</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;"> AddSort</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;">field</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;"> string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;"> order</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;"> string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    qb</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">db </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> qb</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">db</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Order</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">fmt</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Sprintf</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">%s</span><span style="--shiki-light:#E53935;--shiki-dark:#F07178;"> %s</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> field</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> order</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">))</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">func</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> (</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;">qb </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">*</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">QueryBuilder</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;"> Paginate</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;">page</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;"> pageSize</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;"> int</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    offset </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> (</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">page </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">-</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 1</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> *</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> pageSize</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    qb</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">db </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> qb</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">db</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Limit</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">pageSize</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">).</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Offset</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">offset</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">func</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> (</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;">qb </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">*</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">QueryBuilder</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;"> Find</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;">dest</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> interface{})</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    qb</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">db</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Table</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">qb</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">tableName</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">).</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Find</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">dest</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">func</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> (</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;">qb </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">*</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">QueryBuilder</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;"> Count</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;">count</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> *</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;">int64</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    qb</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">db</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Table</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">qb</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">tableName</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">).</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Count</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">count</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">}</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`\`\`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">bash</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">**3. 数据权限过滤**</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">\`\`\`</span><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">go</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">// 注入数据权限条件</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">func</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> (</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;">s </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">*</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">DynamicDataService</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;"> applyDataPermission</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;">qb</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> *</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">QueryBuilder</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;"> userID</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;"> uint</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic;"> modelCode</span><span style="--shiki-light:#9C3EDA;--shiki-dark:#C792EA;"> string</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">    // 获取用户的数据权限规则</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">    rules </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> s</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">getDataPermissionRules</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">userID</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> modelCode</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    for</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> _</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> rule </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> range</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> rules </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">        switch</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> rule</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Type </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">        case</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">own</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">            // 只能看自己创建的数据</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">            qb</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">AddFilter</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">Filter</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">{</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Field</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">created_by</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> Operator</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">eq</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> Value</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> userID</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">})</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">        case</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">dept</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">            // 只能看本部门的数据</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">            deptID </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> s</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">getUserDeptID</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">userID</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">)</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">            qb</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">AddFilter</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#E2931D;--shiki-dark:#FFCB6B;">Filter</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">{</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Field</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">dept_id</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> Operator</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">eq</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> Value</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> deptID</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">})</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">        case</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">custom</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">            // 自定义条件</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">            qb</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">db </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">=</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> qb</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">db</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Where</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">rule</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Condition</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> rule</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">Values</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">...)</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">        }</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    }</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">}</span></span></code></pre></div><hr><h2 id="七、配置文件示例" tabindex="-1">七、配置文件示例 <a class="header-anchor" href="#七、配置文件示例" aria-label="Permalink to &quot;七、配置文件示例&quot;">​</a></h2><h3 id="_7-1-主配置文件-config-yaml" tabindex="-1">7.1 主配置文件 (config.yaml) <a class="header-anchor" href="#_7-1-主配置文件-config-yaml" aria-label="Permalink to &quot;7.1 主配置文件 (config.yaml)&quot;">​</a></h3><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes material-theme-lighter material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;"># 应用配置</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">app</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">  name</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">Low-Code Platform</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">  version</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">1.0.0</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">  mode</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">debug</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">  # debug/release</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">  port</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 8080</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">  read_timeout</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 60s</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">  write_timeout</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 60s</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;"># 数据库配置</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">database</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">  postgres</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">    host</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> localhost</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">    port</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 5432</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">    user</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> postgres</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">    password</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> secret</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">    dbname</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> lowcode</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">    sslmode</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> disable</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">    max_idle_conns</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 10</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">    max_open_conns</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 100</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">    conn_max_lifetime</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 1h</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">    log_level</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> info</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">  # silent/error/warn/info</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;"># Redis 配置</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">redis</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">  mode</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> single</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">  # single/cluster/sentinel</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">  addr</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> localhost:6379</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">  password</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">  db</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 0</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">  pool_size</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 20</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">  min_idle_conns</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 5</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">  max_retries</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 3</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">  dial_timeout</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 5s</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">  read_timeout</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 3s</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">  write_timeout</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 3s</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;"># Elasticsearch 配置</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">elasticsearch</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">  addresses</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    -</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> http://localhost:9200</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">  username</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> elastic</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">  password</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> secret</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">  max_retries</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 3</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">  enable_sniffer</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#FF5370;--shiki-dark:#FF9CAC;"> false</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;"># JWT 配置</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">jwt</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">  secret</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">your-secret-key-change-in-production</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">  expire_hours</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 168</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">  # 7 days</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">  refresh_hours</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 720</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">  # 30 days</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;"># 日志配置</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">logger</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">  level</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> info</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">  # debug/info/warn/error</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">  format</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> json</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">  # json/console</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">  output</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> stdout</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">  # stdout/file</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">  file_path</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> logs/app.log</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">  max_size</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 100</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">  # MB</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">  max_backups</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 10</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">  max_age</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 30</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">  # days</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">  compress</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#FF5370;--shiki-dark:#FF9CAC;"> true</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;"># CORS 配置</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">cors</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">  allow_origins</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    -</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> http://localhost:8080</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    -</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> https://app.example.com</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">  allow_methods</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    -</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> GET</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    -</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> POST</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    -</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> PUT</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    -</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> DELETE</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    -</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> OPTIONS</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">  allow_headers</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    -</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> Origin</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    -</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> Content-Type</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    -</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> Authorization</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    -</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> X-Trace-ID</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">  allow_credentials</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#FF5370;--shiki-dark:#FF9CAC;"> true</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">  max_age</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> 12h</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;"># 限流配置</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">rate_limit</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">  ip_limit</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 100</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">  # requests per minute</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">  user_limit</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 200</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">  enable</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#FF5370;--shiki-dark:#FF9CAC;"> true</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;"># 文件上传配置</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">upload</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">  max_size</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 10485760</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">  # 10MB</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">  allowed_types</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    -</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> image/jpeg</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    -</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> image/png</span></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">    -</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> application/pdf</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">  save_path</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> uploads/</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;"># Casbin 配置</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">casbin</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">  model_path</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> configs/rbac_model.conf</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">  policy_adapter</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> database</span><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">  # database/file</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;"># 监控配置</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">metrics</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">  enable</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#FF5370;--shiki-dark:#FF9CAC;"> true</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">  path</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;"> /metrics</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">  port</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;"> 9090</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">\`\`\`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">bash</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">### 7.2 环境变量文件 (.env.example)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">\`\`\`</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">bash</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;"># 应用环境</span></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">APP_MODE=debug</span></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">APP_PORT=8080</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;"># 数据库</span></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">DB_HOST=localhost</span></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">DB_PORT=5432</span></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">DB_USER=postgres</span></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">DB_PASSWORD=secret</span></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">DB_NAME=lowcode</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;"># Redis</span></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">REDIS_ADDR=localhost:6379</span></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">REDIS_PASSWORD=</span></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">REDIS_DB=0</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;"># Elasticsearch</span></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">ES_ADDRESSES=http://localhost:9200</span></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">ES_USERNAME=elastic</span></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">ES_PASSWORD=secret</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;"># JWT</span></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">JWT_SECRET=your-secret-key-change-in-production</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;"># 日志</span></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">LOG_LEVEL=info</span></span>
<span class="line"><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">LOG_FORMAT=json</span></span></code></pre></div><h3 id="_7-3-casbin-模型文件-rbac-model-conf" tabindex="-1">7.3 Casbin 模型文件 (rbac_model.conf) <a class="header-anchor" href="#_7-3-casbin-模型文件-rbac-model-conf" aria-label="Permalink to &quot;7.3 Casbin 模型文件 (rbac\\_model.conf)&quot;">​</a></h3><div class="language-ini vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ini</span><pre class="shiki shiki-themes material-theme-lighter material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">[request_definition]</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">r</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> sub, obj, act</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">[policy_definition]</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">p</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> sub, obj, act</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">[role_definition]</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">g</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> _, _</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">[policy_effect]</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">e</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> some(where (</span><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">p.eft</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">= allow))</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">[matchers]</span></span>
<span class="line"><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">m</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;"> g(r.sub, p.sub) &amp;&amp; keyMatch2(r.obj, p.obj) &amp;&amp; (</span><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">r.act</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">= p.act || </span><span style="--shiki-light:#E53935;--shiki-dark:#F07178;">p.act</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">= </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">*</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">)</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">\`\`\`bash</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">---</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">## 八、技术栈总结</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic;">### 后端核心依赖</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">\`\`\`go</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">// Web 框架</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">github.com/gin-gonic/gin</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">// ORM</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">gorm.io/gorm</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">gorm.io/driver/postgres</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">gorm.io/datatypes  // JSONB 支持</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">// Redis</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">github.com/redis/go-redis/v9</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">// Elasticsearch</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">github.com/elastic/go-elasticsearch/v8</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">github.com/olivere/elastic/v7</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">// 配置管理</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">github.com/spf13/viper</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">// 日志</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">go.uber.org/zap</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">// JWT</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">github.com/golang-jwt/jwt/v5</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">// 参数校验</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">github.com/go-playground/validator/v10</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">// 权限</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">github.com/casbin/casbin/v2</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">github.com/casbin/gorm-adapter/v3</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">// 规则引擎</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">github.com/Knetic/govaluate</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">github.com/antonmedv/expr</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">// 工具库</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">github.com/google/uuid</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">github.com/spf13/cast</span></span>
<span class="line"><span style="--shiki-light:#90A4AE;--shiki-dark:#BABED8;">golang.org/x/crypto</span></span></code></pre></div><hr><h2 id="九、开发流程建议" tabindex="-1">九、开发流程建议 <a class="header-anchor" href="#九、开发流程建议" aria-label="Permalink to &quot;九、开发流程建议&quot;">​</a></h2><h3 id="_9-1-第一阶段-基础框架搭建" tabindex="-1">9.1 第一阶段：基础框架搭建 <a class="header-anchor" href="#_9-1-第一阶段-基础框架搭建" aria-label="Permalink to &quot;9.1 第一阶段：基础框架搭建&quot;">​</a></h3><ol><li>初始化项目结构</li><li>配置 Gin + GORM + Redis</li><li>实现基础中间件（Auth、Logger、Recovery）</li><li>实现统一响应格式</li><li>搭建 RBAC 权限体系</li></ol><h3 id="_9-2-第二阶段-核心功能开发" tabindex="-1">9.2 第二阶段：核心功能开发 <a class="header-anchor" href="#_9-2-第二阶段-核心功能开发" aria-label="Permalink to &quot;9.2 第二阶段：核心功能开发&quot;">​</a></h3><ol><li>实现元数据服务（页面、组件、数据模型）</li><li>实现表单引擎（设计、校验、联动）</li><li>实现动态数据服务（通用 CRUD）</li><li>集成 Elasticsearch 搜索</li></ol><h3 id="_9-3-第三阶段-高级功能" tabindex="-1">9.3 第三阶段：高级功能 <a class="header-anchor" href="#_9-3-第三阶段-高级功能" aria-label="Permalink to &quot;9.3 第三阶段：高级功能&quot;">​</a></h3><ol><li>实现工作流引擎</li><li>实现规则引擎</li><li>实现版本管理</li><li>完善缓存策略</li></ol><h3 id="_9-4-第四阶段-优化和测试" tabindex="-1">9.4 第四阶段：优化和测试 <a class="header-anchor" href="#_9-4-第四阶段-优化和测试" aria-label="Permalink to &quot;9.4 第四阶段：优化和测试&quot;">​</a></h3><ol><li>性能优化（查询优化、缓存优化）</li><li>单元测试和集成测试</li><li>API 文档生成（Swagger）</li><li>部署和监控</li></ol><hr><p><strong>文档版本：</strong> v1.0 <strong>最后更新：</strong> 2024-01-01 <strong>维护者：</strong> 低代码平台团队</p>`,112)])])}const F=i(k,[["render",l]]);export{A as __pageData,F as default};
