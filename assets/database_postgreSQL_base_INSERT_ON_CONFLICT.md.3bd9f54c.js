import{_ as s,o as a,c as n,R as l}from"./chunks/framework.333b51ca.js";const F=JSON.parse('{"title":"PostgreSQL INSERT ON CONFLICT 语句用法与实例","description":"","frontmatter":{},"headers":[],"relativePath":"database/postgreSQL/base/INSERT_ON_CONFLICT.md","filePath":"database/postgreSQL/base/INSERT_ON_CONFLICT.md","lastUpdated":1690337946000}'),o={name:"database/postgreSQL/base/INSERT_ON_CONFLICT.md"},p=l(`<h1 id="postgresql-insert-on-conflict-语句用法与实例" tabindex="-1">PostgreSQL INSERT ON CONFLICT 语句用法与实例 <a class="header-anchor" href="#postgresql-insert-on-conflict-语句用法与实例" aria-label="Permalink to &quot;PostgreSQL INSERT ON CONFLICT 语句用法与实例&quot;">​</a></h1><p>本文介绍了如何在 PostgreSQL INSERT ON CONFLICT 语句处理插入数据时存在冲突的情况。</p><p>PostgreSQL <code>INSERT ON CONFLICT</code> 语句允许您在插入数据时处理一些数据冲突的情况，如果不存在冲突，则正常插入，如果存在冲突，可以更新已有的行。也就是说 <code>INSERT ON CONFLICT</code> 语句实现了 upsert 功能。</p><p>该 <code>INSERT ON CONFLICT</code> 语句是在 PostgreSQL 9.5 引入的。</p><h2 id="postgresql-insert-on-conflict-语法" tabindex="-1">PostgreSQL <code>INSERT ON CONFLICT</code> 语法 <a class="header-anchor" href="#postgresql-insert-on-conflict-语法" aria-label="Permalink to &quot;PostgreSQL \`INSERT ON CONFLICT\` 语法&quot;">​</a></h2><p>要在 PostgreSQL 实现 upsert 功能，请按照如下语法使用 <code>INSERT ON CONFLICT</code> 语句：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">INSERT INTO</span><span style="color:#A6ACCD;"> table_name(column_list)</span></span>
<span class="line"><span style="color:#F78C6C;">VALUES</span><span style="color:#A6ACCD;">(value_list)</span></span>
<span class="line"><span style="color:#F78C6C;">ON</span><span style="color:#A6ACCD;"> CONFLICT conflict_target conflict_action</span></span>
<span class="line"><span style="color:#A6ACCD;">[RETURNING {* | column_names}];;</span></span></code></pre></div><p>相比较于 <code>INSERT</code> 语句来说，<code>INSERT ON CONFLICT</code> 只是多了 <code>ON CONFLICT</code> 子句。</p><p>这里：</p><ul><li><code>conflict_target</code> 是存在冲突的对象，它可以是以下之一： <ul><li>一个列名。该列必须是主键或者唯一索引。</li><li><code>ON CONSTRAINT constraint_name</code>， 并且 <code>constraint_name</code> 必须是<a href="/database/postgreSQL/databaseAndTable/唯一约束.html">唯一约束</a> 的名称。</li><li><a href="/database/postgreSQL/base/WHERE.html">WHERE</a> 子句。</li></ul></li><li><code>conflict_action</code> 是存在冲突时要采取的动作，它可以是以下之一： <ul><li><code>DO NOTHING</code>: 如果存在冲突，不采取任何动作。</li><li><code>DO UPDATE</code>: 如果存在冲突，使用 <code>DO UPDATE SET column_1 = value_1, .. WHERE condition</code> 更新表中的字段。</li></ul></li></ul><h2 id="postgresql-insert-on-conflict-实例" tabindex="-1">PostgreSQL <code>INSERT ON CONFLICT</code> 实例 <a class="header-anchor" href="#postgresql-insert-on-conflict-实例" aria-label="Permalink to &quot;PostgreSQL \`INSERT ON CONFLICT\` 实例&quot;">​</a></h2><p>我们要在 <code>testdb</code> 数据库中演示下面的示例。请先使用下面的语句创建 <code>testdb</code> 数据库：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">CREATE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">DATABASE</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">testdb</span><span style="color:#A6ACCD;">;</span></span></code></pre></div><p>选择 <code>testdb</code> 数据库为当前数据库：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">\\c testdb;</span></span></code></pre></div><p>为了演示，我们需要<a href="/database/postgreSQL/databaseAndTable/创建表.html">创建一个新表</a>，命名为 <code>users</code>。：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">DROP</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">TABLE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">IF</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">EXISTS</span><span style="color:#A6ACCD;"> users;</span></span>
<span class="line"><span style="color:#F78C6C;">CREATE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">TABLE</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">users</span><span style="color:#A6ACCD;"> (</span></span>
<span class="line"><span style="color:#A6ACCD;">  id </span><span style="color:#C792EA;">SERIAL</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">PRIMARY KEY</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  nickname </span><span style="color:#C792EA;">VARCHAR</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">50</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">NOT NULL</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  login_name </span><span style="color:#C792EA;">VARCHAR</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">50</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">UNIQUE</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  notes </span><span style="color:#C792EA;">VARCHAR</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">255</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">);</span></span></code></pre></div><p>这里，我们创建了一个 <code>users</code> 表，它有 <code>id</code>, <code>nickname</code>, <code>login_name</code>, 和 <code>notes</code> 四列， 其中 <code>login_name</code> 是一个唯一索引列。</p><p>让我们再使用 <a href="/database/postgreSQL/base/INSERT.html"><code>INSERT</code></a> 语句插入一些行到 <code>users</code> 表：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">INSERT INTO</span></span>
<span class="line"><span style="color:#A6ACCD;">    users (nickname, login_name, notes)</span></span>
<span class="line"><span style="color:#F78C6C;">VALUES</span></span>
<span class="line"><span style="color:#A6ACCD;">    (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Tim</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">tim</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">This is Tim</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">    (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Tom</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">tom</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">This is Tom</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">);</span></span></code></pre></div><p>让我们再插入一个新行，其中带有和已有行重复的 <code>login_name</code>:</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">INSERT INTO</span></span>
<span class="line"><span style="color:#A6ACCD;">    users (nickname, login_name, notes)</span></span>
<span class="line"><span style="color:#F78C6C;">VALUES</span></span>
<span class="line"><span style="color:#A6ACCD;">    (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Tim2</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">tim</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">This is Tim2</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">);</span></span></code></pre></div><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">ERROR:</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">duplicate</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">key</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">value</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">violates</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">unique</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">constraint</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">users_login_name_key</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#FFCB6B;">DETAIL:</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">Key</span><span style="color:#A6ACCD;"> (login_name)=(</span><span style="color:#FFCB6B;">tim</span><span style="color:#A6ACCD;">) already exists.</span></span></code></pre></div><p>让我们使用 <code>INSERT ON CONFLICT</code> 语句重试一次，以便在存在重复 <code>login_name</code> 时采取一些动作。我们可以采取两种动作：</p><ul><li><p>使用 <code>DO NOTHING</code> 表示不做任何事情：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">INSERT INTO</span></span>
<span class="line"><span style="color:#A6ACCD;">    users (nickname, login_name, notes)</span></span>
<span class="line"><span style="color:#F78C6C;">VALUES</span></span>
<span class="line"><span style="color:#A6ACCD;">    (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Tim2</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">tim</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">This is Tim2</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#F78C6C;">ON</span><span style="color:#A6ACCD;"> CONFLICT (login_name) DO NOTHING;</span></span></code></pre></div><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">INSERT</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span></span></code></pre></div><p>这里，我们使用 <code>DO NOTHING</code> 选项。然后，PostgreSQL 没有返回错误。</p></li><li><p>使用 <code>DO UPDATE</code> 更新其他的字段：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">INSERT INTO</span></span>
<span class="line"><span style="color:#A6ACCD;">    users (nickname, login_name, notes)</span></span>
<span class="line"><span style="color:#F78C6C;">VALUES</span></span>
<span class="line"><span style="color:#A6ACCD;">    (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Tim2</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">tim</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">This is Tim2</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#F78C6C;">ON</span><span style="color:#A6ACCD;"> CONFLICT (login_name)</span></span>
<span class="line"><span style="color:#A6ACCD;">    DO </span><span style="color:#F78C6C;">UPDATE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">SET</span><span style="color:#A6ACCD;"> nickname </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Tim2</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, notes </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">This is Tim2</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">RETURNING </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">;</span></span></code></pre></div><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">id</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">nickname</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">login_name</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">notes</span></span>
<span class="line"><span style="color:#FFCB6B;">----+----------+------------+--------------</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">1</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Tim2</span><span style="color:#A6ACCD;">     </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">tim</span><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">This</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">is</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Tim2</span></span>
<span class="line"><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">1</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">row</span><span style="color:#89DDFF;">)</span></span></code></pre></div><p>在 <code>DO UPDATE</code> 子句中，您还可以使用 <code>EXCLUDED</code> 对象引用引发冲突的数据，上面的语句可以使用 <code>EXCLUDED</code> 修改为如下语句：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">INSERT INTO</span></span>
<span class="line"><span style="color:#A6ACCD;">    users (nickname, login_name, notes)</span></span>
<span class="line"><span style="color:#F78C6C;">VALUES</span></span>
<span class="line"><span style="color:#A6ACCD;">    (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Tim2</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">tim</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">This is Tim2</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#F78C6C;">ON</span><span style="color:#A6ACCD;"> CONFLICT (login_name)</span></span>
<span class="line"><span style="color:#A6ACCD;">    DO </span><span style="color:#F78C6C;">UPDATE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">SET</span><span style="color:#A6ACCD;"> nickname </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> EXCLUDED.nickname,</span></span>
<span class="line"><span style="color:#A6ACCD;">                  notes </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> EXCLUDED.notes</span></span>
<span class="line"><span style="color:#A6ACCD;">RETURNING </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">;</span></span></code></pre></div><p>在冲突对象中，除了字段名称，您还可以使用约束名称。上面的语句可以使用约束名称 <code>users_login_name_key</code> 代替列名 <code>login_name</code>:</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">INSERT INTO</span></span>
<span class="line"><span style="color:#A6ACCD;">    users (nickname, login_name, notes)</span></span>
<span class="line"><span style="color:#F78C6C;">VALUES</span></span>
<span class="line"><span style="color:#A6ACCD;">    (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Tim3</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">tim</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">This is Tim3</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#F78C6C;">ON</span><span style="color:#A6ACCD;"> CONFLICT </span><span style="color:#F78C6C;">ON</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">CONSTRAINT</span><span style="color:#A6ACCD;"> users_login_name_key</span></span>
<span class="line"><span style="color:#A6ACCD;">    DO </span><span style="color:#F78C6C;">UPDATE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">SET</span><span style="color:#A6ACCD;"> nickname </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> EXCLUDED.nickname,</span></span>
<span class="line"><span style="color:#A6ACCD;">                  notes </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> EXCLUDED.notes</span></span>
<span class="line"><span style="color:#A6ACCD;">RETURNING </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">;</span></span></code></pre></div><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">id</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">nickname</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">login_name</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">notes</span></span>
<span class="line"><span style="color:#FFCB6B;">----+----------+------------+--------------</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">1</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Tim3</span><span style="color:#A6ACCD;">     </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">tim</span><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">This</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">is</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Tim3</span></span>
<span class="line"><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">1</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">row</span><span style="color:#89DDFF;">)</span></span></code></pre></div></li></ul><h2 id="结论" tabindex="-1">结论 <a class="header-anchor" href="#结论" aria-label="Permalink to &quot;结论&quot;">​</a></h2><p>PostgreSQL <code>INSERT ON CONFLICT</code> 实现了 upsert 功能，以便让您在使用同一个语句既可以 <code>INSERT</code> 也可以 <code>UPDATE</code>。</p>`,27),e=[p];function c(t,C,r,D,y,A){return a(),n("div",null,e)}const d=s(o,[["render",c]]);export{F as __pageData,d as default};
